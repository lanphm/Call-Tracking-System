<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nhập Báo Cáo - Daily Input</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
    <div class="max-w-xl mx-auto p-4 sm:p-8 space-y-6">
        
        <div class="flex justify-between items-center bg-slate-900 p-6 rounded-[30px] text-white shadow-xl">
            <div>
                <h1 class="text-xl font-black italic uppercase tracking-tighter">Daily Report</h1>
                <p id="user-name" class="text-[9px] text-blue-400 font-bold uppercase tracking-widest italic">Đang tải...</p>
            </div>
            <button onclick="location.href='index.html'" class="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase">Đóng</button>
        </div>

        <div class="bg-white p-6 rounded-[40px] shadow-sm border border-slate-200 space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest">Ngày báo cáo</label>
                    <input type="date" id="report-date" class="w-full bg-slate-50 p-4 rounded-2xl border-none font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest">Phòng khám</label>
                    <select id="location-id" class="w-full bg-slate-50 p-4 rounded-2xl border-none font-bold text-sm outline-none appearance-none cursor-pointer"></select>
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest italic">1. Tổng số cuộc gọi (Total Calls)</label>
                    <input type="number" id="total-calls" placeholder="0" class="w-full bg-slate-50 p-5 rounded-2xl border-none font-black text-2xl outline-none focus:bg-blue-50 transition-all text-blue-600">
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest italic">2. Cuộc gọi thành công (Successful)</label>
                    <input type="number" id="success-calls" placeholder="0" class="w-full bg-slate-50 p-5 rounded-2xl border-none font-black text-2xl outline-none focus:bg-green-50 transition-all text-green-600">
                </div>

                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest italic">3. Khách hàng tiềm năng (Hot Leads)</label>
                    <input type="number" id="hot-leads" placeholder="0" class="w-full bg-slate-50 p-5 rounded-2xl border-none font-black text-2xl outline-none focus:bg-red-50 transition-all text-red-600">
                </div>
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-1 block tracking-widest">Ghi chú (Nếu có)</label>
                <textarea id="note" rows="2" class="w-full bg-slate-50 p-4 rounded-2xl border-none font-medium text-sm outline-none" placeholder="Nhập ghi chú quan trọng..."></textarea>
            </div>

            <button onclick="submitReport()" id="btn-submit" class="w-full bg-slate-900 text-white p-5 rounded-[24px] font-black uppercase italic shadow-2xl active:scale-95 transition-all flex justify-center items-center gap-2">
                Gửi báo cáo ngay
            </button>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let currentUserEmail = "";

        async function initForm() {
            // 1. Kiểm tra Auth
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { location.href = 'login.html'; return; }
            currentUserEmail = session.user.email;
            document.getElementById('user-name').innerText = `Nhân viên: ${currentUserEmail}`;

            // 2. Set ngày mặc định là hôm nay
            document.getElementById('report-date').valueAsDate = new Date();

            // 3. Load danh sách phòng khám
            const { data: locs } = await supabaseClient.from('locations').select('*').eq('is_active', true);
            const locSelect = document.getElementById('location-id');
            locs.forEach(l => locSelect.add(new Option(l.name, l.id)));
        }

        async function submitReport() {
            const btn = document.getElementById('btn-submit');
            const data = {
                report_date: document.getElementById('report-date').value,
                location_id: document.getElementById('location-id').value,
                total_calls: parseInt(document.getElementById('total-calls').value) || 0,
                successful_calls: parseInt(document.getElementById('success-calls').value) || 0,
                hot_leads: parseInt(document.getElementById('hot-leads').value) || 0,
                note: document.getElementById('note').value,
                employee_email: currentUserEmail
            };

            if (data.total_calls < data.successful_calls) {
                alert("Lỗi: Số cuộc gọi thành công không thể lớn hơn tổng số cuộc gọi!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Đang gửi...";

            const { error } = await supabaseClient.from('daily_reports').insert([data]);

            if (error) {
                alert("Lỗi khi gửi: " + error.message);
                btn.disabled = false;
                btn.innerText = "Thử lại";
            } else {
                alert("Gửi báo cáo thành công!");
                location.href = 'index.html';
            }
        }

        window.onload = initForm;
    </script>
</body>
</html>
