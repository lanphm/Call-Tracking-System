<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Performance Report - Strategic Hub</title>
    <script src="./config.js?v=refresh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        
        /* Tối ưu Mobile: Ghim cột tên nhân viên */
        .sticky-column { position: sticky; left: 0; background: white; z-index: 10; border-right: 2px solid #f1f5f9; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* Heatmap colors */
        .rate-good { background-color: #dcfce7; color: #166534; } /* Xanh lá */
        .rate-mid { background-color: #fef9c3; color: #854d0e; }  /* Vàng */
        .rate-bad { background-color: #fee2e2; color: #991b1b; }  /* Đỏ */

        select { 
            -webkit-appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1rem;
        }
    </style>
</head>
<body class="p-2 sm:p-6 pb-20">
    <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">
        
        <div class="flex justify-between items-center bg-white p-5 rounded-[28px] border border-slate-200 shadow-sm">
            <div>
                <h1 class="text-lg sm:text-xl font-black italic uppercase tracking-tighter">Strategic Report</h1>
                <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">Efficiency & Conversion Tracking</p>
            </div>
            <button onclick="location.href='index.html'" class="bg-slate-100 p-3 rounded-2xl text-slate-600 hover:bg-slate-200 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            </button>
        </div>

        <div class="bg-white p-3 sm:p-4 rounded-[28px] border border-slate-100 shadow-sm flex flex-col sm:flex-row gap-3">
            <div class="grid grid-cols-2 sm:flex gap-2 flex-1">
                <select id="filter_year" onchange="updateMonthOptions()" class="bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none text-slate-600 flex-1"></select>
                <select id="filter_month" onchange="updateWeekOptions()" class="bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none text-slate-600 flex-1"></select>
            </div>
            <select id="filter_week" class="bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none text-slate-600"></select>
            <button onclick="loadDataByFilter()" class="bg-blue-900 text-white px-8 py-3 rounded-xl text-xs font-black uppercase italic hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-blue-900/20">Lọc Data</button>
        </div>

        <div class="grid lg:grid-cols-2 gap-4 sm:gap-6">
            <div class="bg-white p-5 rounded-[32px] border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 italic">Performance Trend (Daily)</h3>
                <div class="h-[250px] sm:h-[300px]"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-[32px] border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 italic">Conversion vs Show-up Rate</h3>
                <div class="h-[250px] sm:h-[300px]"><canvas id="efficiencyChart"></canvas></div>
            </div>
        </div>

        <div class="bg-white rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-5 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                <h2 class="text-[10px] font-black uppercase italic tracking-widest text-slate-400">Unit Analytics</h2>
                <div id="unit-total-call" class="text-[10px] font-black text-blue-900 italic"></div>
            </div>
            <div class="table-container">
                <table id="unitTable" class="w-full text-left text-[11px] whitespace-nowrap">
                    </table>
            </div>
        </div>

        <div class="bg-white rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-5 border-b border-slate-50 bg-slate-50/50">
                <h2 class="text-[10px] font-black uppercase italic tracking-widest text-slate-400">Staff Contribution (Swipe to see more)</h2>
            </div>
            <div class="table-container">
                <table id="staffTable" class="w-full text-left text-[10px] whitespace-nowrap">
                    </table>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let fullData = [];
        let trendChart, efficiencyChart;

        // --- FILTER LOGIC ---
        function initTimeFilters() {
            const yearSelect = document.getElementById('filter_year');
            const curY = new Date().getFullYear();
            for (let i = curY; i >= 2024; i--) yearSelect.innerHTML += `<option value="${i}">Năm ${i}</option>`;
            updateMonthOptions();
        }

        function updateMonthOptions() {
            const mSelect = document.getElementById('filter_month');
            mSelect.innerHTML = '<option value="all">Cả năm</option>';
            for (let i = 1; i <= 12; i++) mSelect.innerHTML += `<option value="${i}">Tháng ${i}</option>`;
            mSelect.value = new Date().getMonth() + 1;
            updateWeekOptions();
        }

        function updateWeekOptions() {
            const y = document.getElementById('filter_year').value, m = document.getElementById('filter_month').value;
            const wSelect = document.getElementById('filter_week');
            wSelect.innerHTML = '<option value="all">Cả tháng</option>';
            if (m === 'all') return;
            let curr = new Date(y, m - 1, 1);
            curr.setDate(curr.getDate() - (curr.getDay() === 0 ? 6 : curr.getDay() - 1));
            let wNum = 1;
            while (curr <= new Date(y, m, 0)) {
                let s = new Date(curr), e = new Date(curr); e.setDate(e.getDate() + 6);
                wSelect.innerHTML += `<option value="${s.toISOString()}|${e.toISOString()}">Tuần ${wNum} (${s.getDate()}/${s.getMonth()+1}-${e.getDate()}/${e.getMonth()+1})</option>`;
                curr.setDate(curr.getDate() + 7); wNum++;
            }
        }

        // --- DATA LOADING ---
        async function loadDataByFilter() {
            const y = document.getElementById('filter_year').value, m = document.getElementById('filter_month').value, w = document.getElementById('filter_week').value;
            let q = supabaseClient.from('daily_reports').select('*, report_details(*, locations(*)), user_permissions(full_name)').order('report_date', {ascending: true});
            
            if (w !== 'all') {
                const d = w.split('|'); q = q.gte('report_date', d[0].split('T')[0]).lte('report_date', d[1].split('T')[0]);
            } else if (m !== 'all') {
                q = q.gte('report_date', `${y}-${m.padStart(2,'0')}-01`).lte('report_date', new Date(y, m, 0).toISOString().split('T')[0]);
            } else q = q.gte('report_date', `${y}-01-01`).lte('report_date', `${y}-12-31`);

            const { data, error } = await q;
            if (error) return;
            fullData = data;
            processAndRender();
        }

        function processAndRender() {
            let unitPivot = {}, staffPivot = {}, dailyTrend = {}, totalSysC = 0, totalSysS = 0;

            fullData.forEach(r => {
                const date = r.report_date;
                const c = parseInt(r.total_calls) || 0, s = parseInt(r.successful_calls) || 0;
                totalSysC += c; totalSysS += s;

                // Trend Data
                if(!dailyTrend[date]) dailyTrend[date] = { c:0, s:0, b:0, a:0 };
                dailyTrend[date].c += c; dailyTrend[date].s += s;

                const name = r.user_permissions?.full_name || r.employee_email;
                if (!staffPivot[name]) staffPivot[name] = { t:0, s:0, h:0, w:0, b:0, a:0, loc: {} };
                staffPivot[name].t += c; staffPivot[name].s += s;
                staffPivot[name].h += parseInt(r.hot_leads) || 0;
                staffPivot[name].w += parseInt(r.warm_leads) || 0;

                if (r.report_details) {
                    r.report_details.forEach(d => {
                        const ln = d.locations?.name || "N/A", bc = parseInt(d.booked_count) || 0, ac = parseInt(d.attended_count) || 0;
                        if (!unitPivot[ln]) unitPivot[ln] = { t:0, b: 0, a: 0 };
                        unitPivot[ln].b += bc; unitPivot[ln].a += ac;
                        unitPivot[ln].t += c; // Note: This is an approximation for unit-level total calls
                        
                        if (!staffPivot[name].loc[ln]) staffPivot[name].loc[ln] = 0;
                        staffPivot[name].loc[ln] += bc; staffPivot[name].b += bc; staffPivot[name].a += ac;
                        dailyTrend[date].b += bc; dailyTrend[date].a += ac;
                    });
                }
            });

            document.getElementById('unit-total-call').innerText = `SYSTEM TOTAL CALL: ${totalSysC.toLocaleString()}`;
            renderCharts(dailyTrend, staffPivot);
            renderUnitTable(unitPivot, totalSysS, totalSysC);
            renderStaffTable(staffPivot);
        }

        // --- RENDER FUNCTIONS ---
        function getRateClass(val, type) {
            if (type === 'conv') return val > 15 ? 'rate-good' : (val > 7 ? 'rate-mid' : 'rate-bad');
            if (type === 'show') return val > 80 ? 'rate-good' : (val > 50 ? 'rate-mid' : 'rate-bad');
            return '';
        }

        function renderUnitTable(pivot, totalS, totalC) {
            const units = Object.keys(pivot).sort();
            let html = `<thead class="bg-slate-50 border-b">
                <tr><th class="p-4 font-black text-slate-400 uppercase italic">Chỉ số đơn vị</th>
                ${units.map(u => `<th class="p-4 text-center text-blue-900 font-black uppercase italic border-l">${u}</th>`).join('')}</tr></thead><tbody>`;
            
            const rows = [
                { l: 'Success Call', d: units.map(u => totalS) }, // simplified
                { l: 'Booking (Hẹn)', d: units.map(u => pivot[u].b), cls: 'bg-blue-50/30 font-bold' },
                { l: 'Conv. Rate %', d: units.map(u => ((pivot[u].b/totalC)*100).toFixed(1) + '%'), type: 'conv' },
                { l: 'Attendant (Đến)', d: units.map(u => pivot[u].a), cls: 'bg-emerald-50/30 font-bold' },
                { l: 'Show-up Rate %', d: units.map(u => ((pivot[u].a/(pivot[u].b||1))*100).toFixed(0) + '%'), type: 'show' }
            ];

            rows.forEach(r => {
                html += `<tr class="border-b ${r.cls || ''}"><td class="p-4 font-bold text-slate-500 bg-slate-50/30">${r.l}</td>`;
                r.d.forEach((val, i) => {
                    let rateCls = r.type ? getRateClass(parseFloat(val), r.type) : '';
                    html += `<td class="p-4 text-center font-black border-l ${rateCls}">${val}</td>`;
                });
                html += `</tr>`;
            });
            document.getElementById('unitTable').innerHTML = html + '</tbody>';
        }

        function renderStaffTable(staff) {
            const sorted = Object.entries(staff).sort((a,b) => b[1].s - a[1].s);
            const locs = [...new Set(fullData.flatMap(r => r.report_details.map(d => d.locations?.name)))].filter(Boolean).sort();
            
            let html = `<thead class="bg-slate-50 border-b"><tr>
                <th class="p-4 sticky-column z-20 font-black uppercase italic text-slate-400 min-w-[120px]">Nhân sự</th>
                <th class="p-4 text-center font-black uppercase italic text-slate-500">T.Call</th>
                <th class="p-4 text-center font-black uppercase italic text-blue-900">S.Call</th>
                <th class="p-4 text-center font-black uppercase italic text-orange-600">Hot/Warm</th>
                ${locs.map(l => `<th class="p-4 text-center font-black uppercase italic text-slate-400 border-l">${l}</th>`).join('')}
                <th class="p-4 text-center font-black uppercase italic text-indigo-600 border-l bg-indigo-50/30">Tổng Hẹn</th>
                <th class="p-4 text-center font-black uppercase italic text-emerald-600 border-l">Conv %</th>
                <th class="p-4 text-center font-black uppercase italic text-rose-600 border-l">Show-up %</th></tr></thead><tbody>`;

            sorted.forEach(([n, v]) => {
                const cRate = (v.b/(v.t||1))*100, sRate = (v.a/(v.b||1))*100;
                html += `<tr class="border-b hover:bg-slate-50 transition-all">
                    <td class="p-4 sticky-column font-black text-slate-900 uppercase tracking-tighter">${n}</td>
                    <td class="p-4 text-center font-bold text-slate-400">${v.t}</td>
                    <td class="p-4 text-center font-black text-blue-700 bg-blue-50/30">${v.s}</td>
                    <td class="p-4 text-center font-bold"><span class="text-rose-600">${v.h}</span>/<span class="text-orange-400">${v.w}</span></td>
                    ${locs.map(l => `<td class="p-4 text-center font-medium border-l ${v.loc[l]?'text-slate-900':'text-slate-200'}">${v.loc[l]||0}</td>`).join('')}
                    <td class="p-4 text-center font-black text-indigo-700 bg-indigo-50/30 border-l">${v.b}</td>
                    <td class="p-4 text-center font-black border-l ${getRateClass(cRate, 'conv')}">${cRate.toFixed(1)}%</td>
                    <td class="p-4 text-center font-black border-l ${getRateClass(sRate, 'show')}">${sRate.toFixed(0)}%</td></tr>`;
            });
            document.getElementById('staffTable').innerHTML = html + '</tbody>';
        }

        function renderCharts(trend, staff) {
            if(trendChart) trendChart.destroy();
            if(efficiencyChart) efficiencyChart.destroy();

            const labels = Object.keys(trend);
            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Call', data: labels.map(l => trend[l].c), borderColor: '#94a3b8', tension: 0.4, fill: false },
                        { label: 'Hẹn', data: labels.map(l => trend[l].b), borderColor: '#1e40af', tension: 0.4, fill: false },
                        { label: 'Đến', data: labels.map(l => trend[l].a), borderColor: '#10b981', tension: 0.4, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom' } } }
            });

            const sNames = Object.keys(staff).slice(0, 5); // Top 5
            efficiencyChart = new Chart(document.getElementById('efficiencyChart'), {
                type: 'bar',
                data: {
                    labels: sNames,
                    datasets: [
                        { label: 'Conv %', data: sNames.map(n => ((staff[n].b/(staff[n].t||1))*100).toFixed(1)), backgroundColor: '#1e40af' },
                        { label: 'Show-up %', data: sNames.map(n => ((staff[n].a/(staff[n].b||1))*100).toFixed(0)), backgroundColor: '#10b981' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        window.onload = () => { initTimeFilters(); loadDataByFilter(); };
    </script>
</body>
</html>
