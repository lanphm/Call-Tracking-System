<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Báo Cáo - Internal App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
</head>
<body class="bg-slate-50 p-4">
    <div class="max-w-6xl mx-auto space-y-6">
        <div class="flex justify-between items-center bg-slate-900 p-6 rounded-3xl text-white">
            <h1 class="text-xl font-black italic uppercase">Báo cáo hiệu quả</h1>
            <button onclick="location.href='index.html'" class="text-xs bg-white/10 px-4 py-2 rounded-xl uppercase font-bold">Quay lại</button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stat-cards">
            </div>

        <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
            <h2 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">Xu hướng 30 ngày qua</h2>
            <canvas id="mainChart" height="100"></canvas>
        </div>

        <div class="bg-white rounded-[32px] shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                    <tr>
                        <th class="p-4 uppercase italic">Ngày</th>
                        <th class="p-4">Nhân viên</th>
                        <th class="p-4">Calls</th>
                        <th class="p-4">Warm</th>
                        <th class="p-4">Hot</th>
                        <th class="p-4">Booked</th>
                        <th class="p-4">Attended</th>
                    </tr>
                </thead>
                <tbody id="report-table-body" class="font-medium text-slate-700"></tbody>
            </table>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        async function initReport() {
            const { data } = await supabaseClient.from('daily_reports').select('*, report_details(*)').order('report_date', { ascending: false }).limit(30);
            
            // 1. Tính toán Stats
            const totalCalls = data.reduce((s, r) => s + r.total_calls, 0);
            const totalWarm = data.reduce((s, r) => s + r.warm_leads, 0);
            const totalHot = data.reduce((s, r) => s + r.hot_leads, 0);
            const totalAttended = data.reduce((s, r) => s + r.report_details.reduce((ss, d) => ss + d.attended_count, 0), 0);

            const stats = [
                { label: 'Tổng Calls', val: totalCalls, color: 'text-slate-900' },
                { label: 'Warm Leads', val: totalWarm, color: 'text-orange-500' },
                { label: 'Hot Leads', val: totalHot, color: 'text-red-500' },
                { label: 'Đã Đến Khám', val: totalAttended, color: 'text-green-600' }
            ];

            document.getElementById('stat-cards').innerHTML = stats.map(s => `
                <div class="bg-white p-6 rounded-[24px] shadow-sm border border-slate-200">
                    <p class="text-[9px] font-black uppercase text-slate-400 mb-1">${s.label}</p>
                    <p class="text-2xl font-black italic uppercase ${s.color}">${s.val}</p>
                </div>`).join('');

            // 2. Vẽ Biểu đồ
            const chartData = [...data].reverse();
            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: chartData.map(r => r.report_date.split('-').slice(2).join('/')),
                    datasets: [
                        { label: 'Calls', data: chartData.map(r => r.total_calls), borderColor: '#0f172a', tension: 0.4 },
                        { label: 'Warm', data: chartData.map(r => r.warm_leads), borderColor: '#f97316', tension: 0.4 },
                        { label: 'Hot', data: chartData.map(r => r.hot_leads), borderColor: '#ef4444', tension: 0.4 }
                    ]
                }
            });

            // 3. Render Table
            document.getElementById('report-table-body').innerHTML = data.map(r => `
                <tr class="border-t border-slate-50">
                    <td class="p-4 text-xs font-bold">${r.report_date}</td>
                    <td class="p-4 text-xs">${r.employee_email.split('@')[0]}</td>
                    <td class="p-4 font-black">${r.total_calls}</td>
                    <td class="p-4 text-orange-600">${r.warm_leads}</td>
                    <td class="p-4 text-red-600">${r.hot_leads}</td>
                    <td class="p-4 font-bold">${r.report_details.reduce((s, d) => s + d.booked_count, 0)}</td>
                    <td class="p-4 text-green-600 font-bold">${r.report_details.reduce((s, d) => s + d.attended_count, 0)}</td>
                </tr>`).join('');
        }

        window.onload = initReport;
    </script>
</body>
</html>
