<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report - Strategic Hub</title>
    <script src="./config.js?v=refresh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex justify-between items-center bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm">
            <div>
                <h1 class="text-xl font-black italic uppercase tracking-tighter text-slate-900">Performance Report</h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Real-time Data Analytics</p>
            </div>
            <button onclick="location.href='index.html'" class="bg-slate-100 hover:bg-slate-200 p-3 rounded-2xl transition-all text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            </button>
        </div>

        <div class="bg-white p-4 rounded-[28px] border border-slate-100 shadow-sm flex flex-wrap gap-4 items-center">
            <input type="date" id="start_date" class="bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none">
            <span class="text-slate-300 font-bold">→</span>
            <input type="date" id="end_date" class="bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none">
            <button onclick="loadData()" class="bg-blue-900 text-white px-6 py-3 rounded-xl text-xs font-black uppercase italic hover:bg-black transition-all">Lọc dữ liệu</button>
        </div>

        <div class="bg-white rounded-[40px] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-xs font-black uppercase italic tracking-widest text-slate-500">System Performance (By Unit)</h2>
            </div>
            <div id="unit-performance-container" class="overflow-x-auto">
                </div>
        </div>

        <div class="bg-white rounded-[40px] border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-50 bg-slate-50/50">
                <h2 class="text-xs font-black uppercase italic tracking-widest text-slate-500">Staff Contribution Details</h2>
            </div>
            <div id="staff-ranking-body" class="overflow-x-auto">
                </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let fullData = [];

        // Ngưỡng đánh giá màu sắc
        const THRESHOLDS = {
            showUp: { danger: 50, success: 80 },
            conversion: { danger: 5, success: 15 }
        };

        // Thiết lập ngày mặc định (đầu tháng đến hiện tại)
        const now = new Date();
        document.getElementById('start_date').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('end_date').value = now.toISOString().split('T')[0];

        async function loadData() {
            const start = document.getElementById('start_date').value;
            const end = document.getElementById('end_date').value;

            const { data, error } = await supabaseClient
                .from('daily_reports')
                .select('*, report_details(*, locations(*)), user_permissions(full_name)')
                .gte('report_date', start)
                .lte('report_date', end);

            if (error) { alert("Lỗi tải dữ liệu: " + error.message); return; }
            fullData = data;
            processAndRender();
        }

        function processAndRender() {
            let unitPivot = {};
            let staffPivot = {};
            let totalSysC = 0, totalSysS = 0;

            fullData.forEach(r => {
                totalSysC += parseInt(r.total_calls) || 0;
                totalSysS += parseInt(r.successful_calls) || 0;

                const staffName = r.user_permissions?.full_name || r.employee_email;
                if (!staffPivot[staffName]) {
                    staffPivot[staffName] = { t:0, s:0, h:0, w:0, b:0, a:0, locBreakdown: {} };
                }

                staffPivot[staffName].t += parseInt(r.total_calls) || 0;
                staffPivot[staffName].s += parseInt(r.successful_calls) || 0;
                staffPivot[staffName].h += parseInt(r.hot_leads) || 0;
                staffPivot[staffName].w += parseInt(r.warm_leads) || 0;

                if (r.report_details) {
                    r.report_details.forEach(d => {
                        const locName = d.locations?.name || "N/A";
                        const booked = parseInt(d.booked_count) || 0;
                        const attended = parseInt(d.attended_count) || 0;

                        // Tích lũy cho Đơn vị
                        if (!unitPivot[locName]) unitPivot[locName] = { b: 0, a: 0 };
                        unitPivot[locName].b += booked;
                        unitPivot[locName].a += attended;

                        // Tích lũy cho Nhân viên
                        if (!staffPivot[staffName].locBreakdown[locName]) staffPivot[staffName].locBreakdown[locName] = 0;
                        staffPivot[staffName].locBreakdown[locName] += booked;
                        staffPivot[staffName].b += booked;
                        staffPivot[staffName].a += attended;
                    });
                }
            });

            renderUnitTable(unitPivot, totalSysC, totalSysS);
            renderStaffTable(staffPivot);
        }

        function renderUnitTable(pivot, totalC, totalS) {
            const units = Object.keys(pivot).sort();
            const getClr = (v, t) => v < THRESHOLDS[t].danger ? 'text-red-500' : (v > THRESHOLDS[t].success ? 'text-emerald-500' : 'text-blue-700');

            let html = `<table class="w-full text-left border-collapse text-[11px]">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 w-1/4 font-black text-slate-400 uppercase italic">Chỉ số hệ thống</th>
                        ${units.map(u => `<th class="p-4 text-center text-blue-900 font-black uppercase italic">${u}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b"><td class="p-4 font-bold bg-slate-50/30 uppercase text-[9px] text-slate-500">Total Calls</td>${units.map(() => `<td class="p-4 text-center font-black text-slate-400 italic">-</td>`).join('')}</tr>
                    <tr class="border-b bg-slate-50/10"><td class="p-4 font-black uppercase text-slate-900">Hệ thống: ${totalC} Calls / ${totalS} Success</td>${units.map(() => `<td class="p-4"></td>`).join('')}</tr>
                    
                    <tr class="border-b bg-blue-50/30">
                        <td class="p-4 font-black uppercase text-[9px] text-blue-900 italic">Booking (Số hẹn)</td>
                        ${units.map(u => `<td class="p-4 text-center font-black text-blue-800 text-lg">${pivot[u].b}</td>`).join('')}
                    </tr>
                    <tr class="border-b bg-emerald-50/30">
                        <td class="p-4 font-black uppercase text-[9px] text-emerald-800 italic">Attendant (Khách đến)</td>
                        ${units.map(u => `<td class="p-4 text-center font-black text-emerald-600 text-lg">${pivot[u].a}</td>`).join('')}
                    </tr>
                    <tr class="border-b">
                        <td class="p-4 font-bold bg-slate-50/50 uppercase text-[9px] text-slate-500 italic">Show-up Rate (%)</td>
                        ${units.map(u => { 
                            const r = (pivot[u].a / (pivot[u].b || 1)) * 100; 
                            return `<td class="p-4 text-center font-black ${getClr(r, 'showUp')}">${r.toFixed(0)}%</td>`
                        }).join('')}
                    </tr>
                </tbody>
            </table>`;
            document.getElementById('unit-performance-container').innerHTML = html;
        }

        function renderStaffTable(staff) {
            const sorted = Object.entries(staff).sort((a,b) => b[1].s - a[1].s);
            const locationNames = [...new Set(fullData.flatMap(r => r.report_details.map(d => d.locations?.name)))].filter(Boolean).sort();

            let html = `<table class="w-full text-left border-collapse text-[10px]">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 font-black uppercase italic text-slate-400 min-w-[150px]">Nhân sự</th>
                        <th class="p-4 text-center font-black uppercase italic text-blue-900">Success</th>
                        <th class="p-4 text-center font-black uppercase italic text-orange-600">Hot/Warm</th>
                        ${locationNames.map(loc => `<th class="p-4 text-center font-black uppercase italic text-slate-400">${loc}</th>`).join('')}
                        <th class="p-4 text-center font-black uppercase italic text-indigo-600">Tổng Hẹn</th>
                        <th class="p-4 text-center font-black uppercase italic text-emerald-600">Conv %</th>
                        <th class="p-4 text-center font-black uppercase italic text-rose-600">Show-up %</th>
                    </tr>
                </thead>
                <tbody>
                    ${sorted.map(([name, v]) => {
                        const conv = (v.b / (v.t || 1)) * 100;
                        const showup = (v.a / (v.b || 1)) * 100;
                        return `
                        <tr class="border-b hover:bg-slate-50 transition-all">
                            <td class="p-4 font-black text-slate-900 uppercase tracking-tighter">${name}</td>
                            <td class="p-4 text-center font-black text-blue-700 bg-blue-50/30">${v.s}</td>
                            <td class="p-4 text-center font-bold">
                                <span class="text-rose-600">${v.h}</span> <span class="text-slate-300">/</span> <span class="text-orange-400">${v.w}</span>
                            </td>
                            ${locationNames.map(loc => {
                                const c = v.locBreakdown[loc] || 0;
                                return `<td class="p-4 text-center font-medium ${c > 0 ? 'text-slate-900' : 'text-slate-300'}">${c}</td>`;
                            }).join('')}
                            <td class="p-4 text-center font-black text-indigo-700 bg-indigo-50/30">${v.b}</td>
                            <td class="p-4 text-center font-black text-emerald-600">${conv.toFixed(1)}%</td>
                            <td class="p-4 text-center font-black text-rose-600">${showup.toFixed(0)}%</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
            document.getElementById('staff-ranking-body').innerHTML = html;
        }

        window.onload = loadData;
    </script>
</body>
</html>
