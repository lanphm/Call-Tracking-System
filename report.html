<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CMS Report</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CallMS">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/headset.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('PWA Ready'))
            .catch(err => console.log('PWA Error', err));
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-btn.active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 800; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bg-gradient-header { background: linear-gradient(135deg, #1e40af 0%, #1e1b4b 100%); }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-black italic text-slate-900 uppercase tracking-tighter">Analytics Hub</h1>
                <p class="text-[10px] font-bold text-slate-400">ACC CMS PERFORMANCE SYSTEM</p>
            </div>
            
            <div class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl shadow-sm border border-slate-100 w-full md:w-auto">
                <select id="year-filter" class="bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none">
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                </select>
                <select id="month-filter" onchange="toggleFilters()" class="bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none">
                    <option value="all">Cả năm</option>
                    <script>
                        for(let i=1; i<=12; i++) document.write(`<option value="${i}">Tháng ${i}</option>`);
                    </script>
                </select>
                <select id="week-filter" class="hidden bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none">
                    <option value="all">Cả tháng</option>
                    <option value="1">Tuần 1 (1-7)</option>
                    <option value="2">Tuần 2 (8-14)</option>
                    <option value="3">Tuần 3 (15-21)</option>
                    <option value="4">Tuần 4 (22-31)</option>
                </select>
                <select id="staff-filter" class="bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none max-w-[120px]">
                    <option value="all">Tất cả nhân viên</option>
                </select>
                <button onclick="loadData()" class="bg-blue-900 text-white text-[10px] font-black uppercase px-4 py-2 rounded-lg hover:bg-blue-700">Lọc</button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="summary-badges"></div>

        <div class="flex gap-6 mb-6 border-b border-slate-200">
            <button onclick="switchTab('tab-overview', this)" class="tab-btn active pb-2 text-[11px] uppercase tracking-wider">Tổng quan Clinic</button>
            <button onclick="switchTab('tab-staff', this)" class="tab-btn pb-2 text-[11px] uppercase tracking-wider text-slate-400">Hiệu suất Nhân viên</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <div id="clinic-performance-container" class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-6 overflow-x-auto"></div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-200 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 italic">Biểu đồ tăng trưởng</h3>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-600"></span> Success Call</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Booking</span>
                    </div>
                </div>
                <canvas id="performanceChart" height="120"></canvas>
            </div>
        </div>

        <div id="tab-staff" class="tab-content">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="p-3 bg-slate-900 text-white font-black italic uppercase text-[9px]">Xếp hạng Telesale</div>
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-3 font-black uppercase">Nhân viên</th>
                            <th class="p-3 font-black uppercase text-center">Calls</th>
                            <th class="p-3 font-black uppercase text-center">S.C</th>
                            <th class="p-3 font-black uppercase text-center">% Hot/S.C</th>
                        </tr>
                    </thead>
                    <tbody id="staff-ranking-body"></tbody>
                </table>
            </div>
            <div id="history-container" class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-3 bg-blue-900 text-white font-black italic uppercase text-[9px]">Lịch sử dữ liệu</div>
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-3 font-black uppercase">Ngày/Tháng</th>
                            <th class="p-3 font-black uppercase text-center">Calls</th>
                            <th class="p-3 font-black uppercase text-center">Success</th>
                            <th class="p-3 font-black uppercase text-center text-orange-500">Hot</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // NGƯỠNG HIỂN THỊ MÀU SẮC (Bạn có thể sửa ở đây)
        const CONFIG = {
            thresholds: {
                showUp: { danger: 25, success: 45 },
                conversion: { danger: 8, success: 18 }
            }
        };

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let chartInstance = null;
        let fullData = [];

        function toggleFilters() {
            const isMonthAll = document.getElementById('month-filter').value === 'all';
            document.getElementById('week-filter').classList.toggle('hidden', isMonthAll);
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-slate-400'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
        }

        async function loadData() {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const week = document.getElementById('week-filter').value;
            
            let start, end;
            if (month === 'all') {
                start = `${year}-01-01`; end = `${year}-12-31`;
            } else {
                if (week === 'all') {
                    start = `${year}-${month.padStart(2, '0')}-01`;
                    end = new Date(year, month, 0).toISOString().split('T')[0];
                } else {
                    const dStart = (week - 1) * 7 + 1;
                    const dEnd = week == 4 ? 31 : week * 7;
                    start = `${year}-${month.padStart(2, '0')}-${String(dStart).padStart(2, '0')}`;
                    end = `${year}-${month.padStart(2, '0')}-${String(dEnd).padStart(2, '0')}`;
                }
            }

            const { data, error } = await supabaseClient
                .from('daily_reports')
                .select(`*, user_permissions(full_name), report_details(*, locations(name))`)
                .gte('report_date', start)
                .lte('report_date', end)
                .order('report_date', { ascending: true });

            if (!error) {
                fullData = data;
                updateStaffDropdown(data);
                renderAll();
            }
        }

        function updateStaffDropdown(data) {
            const staff = [...new Set(data.map(r => JSON.stringify({email: r.employee_email, name: r.user_permissions?.full_name})))];
            const select = document.getElementById('staff-filter');
            const current = select.value;
            select.innerHTML = '<option value="all">Tất cả nhân viên</option>';
            staff.forEach(s => {
                const obj = JSON.parse(s);
                select.innerHTML += `<option value="${obj.email}">${obj.name || obj.email}</option>`;
            });
            select.value = current;
        }

        function renderAll() {
            const selectedStaff = document.getElementById('staff-filter').value;
            const isYearly = document.getElementById('month-filter').value === 'all';
            
            const filtered = selectedStaff === 'all' ? fullData : fullData.filter(r => r.employee_email === selectedStaff);
            
            let gC=0, gS=0, gB=0, gA=0, gH=0;
            const clinicPivot = {};
            const staffPivot = {};
            const timePivot = {};

            filtered.forEach(r => {
                // Chỉ số tổng hệ thống
                gC += r.total_calls || 0;
                gS += r.successful_calls || 0;
                gH += r.hot_leads || 0;

                // Pivot theo thời gian
                const tKey = isYearly ? `Tháng ${new Date(r.report_date).getMonth() + 1}` : r.report_date;
                if(!timePivot[tKey]) timePivot[tKey] = {s: 0, b: 0, c: 0, h: 0};
                timePivot[tKey].s += r.successful_calls || 0;
                timePivot[tKey].c += r.total_calls || 0;
                timePivot[tKey].h += r.hot_leads || 0;

                // Pivot theo nhân viên
                const name = r.user_permissions?.full_name || r.employee_email;
                if(!staffPivot[name]) staffPivot[name] = {c:0, s:0, h:0};
                staffPivot[name].c += r.total_calls || 0;
                staffPivot[name].s += r.successful_calls || 0;
                staffPivot[name].h += r.hot_leads || 0;

                // Pivot theo Clinic (Bảng con)
                if(r.report_details) {
                    r.report_details.forEach(d => {
                        const loc = d.locations?.name || 'Chưa rõ';
                        if(!clinicPivot[loc]) clinicPivot[loc] = {b:0, a:0, leads: 0};
                        clinicPivot[loc].b += d.booked_count || 0;
                        clinicPivot[loc].a += d.attended_count || 0;
                        clinicPivot[loc].leads += r.warm_leads || 0;
                        gB += d.booked_count || 0;
                        gA += d.attended_count || 0;
                        timePivot[tKey].b += d.booked_count || 0;
                    });
                }
            });

            renderBadges(gC, gS, gB, gA);
            renderClinicTable(clinicPivot, gC, gB);
            renderStaffTable(staffPivot);
            renderHistoryTable(timePivot);
            updateChart(timePivot);
        }

        function renderBadges(c, s, b, a) {
            document.getElementById('summary-badges').innerHTML = `
                <div class="bg-gradient-header p-4 rounded-3xl text-white shadow-sm">
                    <p class="text-[9px] font-black opacity-50 uppercase italic">Calls/Success</p>
                    <p class="text-xl font-black italic tracking-tighter">${c} <span class="text-xs opacity-70">/ ${s}</span></p>
                </div>
                <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase italic">Total Bookings</p>
                    <p class="text-xl font-black italic text-blue-900 tracking-tighter">${b}</p>
                </div>
                <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase italic">Conv. Rate</p>
                    <p class="text-xl font-black italic text-blue-900 tracking-tighter">${((b/(c||1))*100).toFixed(1)}%</p>
                </div>
                <div class="bg-emerald-500 p-4 rounded-3xl text-white shadow-sm">
                    <p class="text-[9px] font-black opacity-50 uppercase italic">Attendants</p>
                    <p class="text-xl font-black italic tracking-tighter">${a}</p>
                </div>
            `;
        }

        function renderClinicTable(pivot, totalC, totalB) {
            const clinics = Object.keys(pivot);
            const getClr = (val, type) => {
                const t = CONFIG.thresholds[type];
                if(val < t.danger) return 'text-red-600 font-black';
                if(val > t.success) return 'text-emerald-600 font-black';
                return 'text-blue-700 font-black';
            };

            let html = `
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-3 border-r w-1/4"></th>${clinics.map(c => `<th class="p-3 text-center border-r text-blue-900 font-black text-[10px] uppercase">${c}</th>`).join('')}</tr>
                    </thead>
                    <tbody class="text-[11px]">
                        <tr class="border-b"><td class="p-3 font-bold bg-slate-50">Total Calls (System)</td><td colspan="${clinics.length}" class="text-center font-black text-blue-900 bg-blue-50/30 text-sm">${totalC}</td></tr>
                        <tr class="border-b"><td class="p-3 font-bold bg-slate-50 italic">Total Bookings (All)</td><td colspan="${clinics.length}" class="text-center font-black text-blue-900 text-sm">${totalB}</td></tr>
                        <tr class="border-b"><td class="p-3 font-bold bg-slate-50">Bookings per Clinic</td>${clinics.map(c => `<td class="p-3 text-center border-l font-bold">${pivot[c].b}</td>`).join('')}</tr>
                        <tr class="border-b"><td class="p-3 font-bold bg-slate-50">Conv. Rate (B/C)</td>${clinics.map(c => {
                            const rate = (pivot[c].b/(totalC||1))*100;
                            return `<td class="p-3 text-center border-l ${getClr(rate, 'conversion')}">${rate.toFixed(1)}%</td>`;
                        }).join('')}</tr>
                        <tr class="border-b"><td class="p-3 font-bold bg-slate-50">Show-up Rate (A/B)</td>${clinics.map(c => {
                            const rate = (pivot[c].a/(pivot[c].b||1))*100;
                            return `<td class="p-3 text-center border-l ${getClr(rate, 'showUp')}">${rate.toFixed(0)}%</td>`;
                        }).join('')}</tr>
                        <tr class="bg-blue-900 text-white font-black"><td class="p-3 italic">New Patients (Attendants)</td>${clinics.map(c => `<td class="p-3 text-center border-l border-white/10">${pivot[c].a}</td>`).join('')}</tr>
                    </tbody>
                </table>`;
            document.getElementById('clinic-performance-container').innerHTML = html;
        }

        function renderStaffTable(staff) {
            const sorted = Object.entries(staff).sort((a,b) => b[1].s - a[1].s);
            document.getElementById('staff-ranking-body').innerHTML = sorted.map(([name, v]) => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3 font-bold text-slate-700">${name}</td>
                    <td class="p-3 text-center">${v.c}</td>
                    <td class="p-3 text-center font-black text-blue-900">${v.s}</td>
                    <td class="p-3 text-center">
                        <span class="bg-orange-50 text-orange-600 px-2 py-0.5 rounded-full font-bold text-[9px]">
                            ${((v.h/(v.s||1))*100).toFixed(0)}% Hot
                        </span>
                    </td>
                </tr>`).join('');
        }

        function renderHistoryTable(time) {
            document.getElementById('history-body').innerHTML = Object.entries(time).reverse().map(([k, v]) => `
                <tr class="border-b hover:bg-slate-50 italic font-medium">
                    <td class="p-3 text-slate-500">${k}</td>
                    <td class="p-3 text-center">${v.c}</td>
                    <td class="p-3 text-center font-bold text-blue-900">${v.s}</td>
                    <td class="p-3 text-center font-bold text-orange-500">${v.h}</td>
                </tr>`).join('');
        }

        function updateChart(timeData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(timeData),
                    datasets: [
                        { label: 'Success', data: Object.values(timeData).map(v => v.s), borderColor: '#2563eb', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(37, 99, 235, 0.05)' },
                        { label: 'Booking', data: Object.values(timeData).map(v => v.b), borderColor: '#10b981', borderWidth: 3, tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 9, weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } }
                    }
                }
            });
        }

        window.onload = loadData;
    </script>
</body>
</html>
