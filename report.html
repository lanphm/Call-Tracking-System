<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Call Center 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-[30px] shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">1. Chọn Năm</label>
                <select id="filter-year" onchange="initFilters()" class="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none border-none ring-1 ring-slate-200">
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">2. Chế độ xem</label>
                <select id="view-mode" onchange="toggleViewMode()" class="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none border-none ring-1 ring-slate-200">
                    <option value="year">Cả Năm (Theo tháng)</option>
                    <option value="month">Theo Tháng (Theo tuần)</option>
                    <option value="week">Chi tiết Tuần (Theo ngày)</option>
                </select>
            </div>

            <div id="sub-filter-container" class="md:col-span-1">
                </div>

            <button onclick="fetchData()" class="bg-slate-900 text-white h-[48px] rounded-xl font-black uppercase italic hover:bg-blue-600 transition-all">Lấy dữ liệu</button>
        </div>

        <div class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h2 id="chart-title" class="text-xs font-black uppercase italic tracking-widest text-slate-500">Hiệu suất cuộc gọi</h2>
                <div class="flex gap-4 text-[10px] font-bold uppercase italic">
                    <span class="text-blue-500">● Warm Leads</span>
                    <span class="text-red-500">● Hot Leads</span>
                </div>
            </div>
            <div class="h-[400px]">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let myChart = null;

        function initFilters() {
            toggleViewMode();
        }

        function toggleViewMode() {
            const mode = document.getElementById('view-mode').value;
            const year = document.getElementById('filter-year').value;
            const container = document.getElementById('sub-filter-container');

            if (mode === 'year') {
                container.innerHTML = `<input type="hidden" id="sub-filter" value="all">`;
            } else if (mode === 'month') {
                container.innerHTML = `
                    <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">3. Chọn Tháng</label>
                    <select id="sub-filter" class="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none ring-1 ring-slate-200">
                        ${[...Array(12).keys()].map(m => `<option value="${m+1}">Tháng ${m+1}</option>`).join('')}
                    </select>`;
            } else if (mode === 'week') {
                const weeks = getWeeksInYear(parseInt(year));
                container.innerHTML = `
                    <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">3. Chọn Tuần</label>
                    <select id="sub-filter" class="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none ring-1 ring-slate-200 text-[11px]">
                        ${weeks.map((w, i) => `<option value="${i}">${w.label}</option>`).join('')}
                    </select>`;
            }
        }

        function getWeeksInYear(year) {
            const weeks = [];
            let d = new Date(year, 0, 1);
            while (d.getDay() !== 1) d.setDate(d.getDate() + 1);
            while (d.getFullYear() <= year) {
                let start = new Date(d);
                let end = new Date(d); end.setDate(end.getDate() + 6);
                if (start.getFullYear() > year) break;
                const fmt = (date) => `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                weeks.push({ label: `Tuần ${weeks.length + 1} (${fmt(start)} - ${fmt(end)})`, start: new Date(start), end: new Date(end) });
                d.setDate(d.getDate() + 7);
            }
            return weeks;
        }

        async function fetchData() {
            const year = document.getElementById('filter-year').value;
            const mode = document.getElementById('view-mode').value;
            const subVal = document.getElementById('sub-filter').value;

            let query = supabaseClient.from('daily_reports').select('*');
            
            if (mode === 'year') {
                query = query.gte('report_date', `${year}-01-01`).lte('report_date', `${year}-12-31`);
            } else if (mode === 'month') {
                const m = subVal.padStart(2, '0');
                query = query.gte('report_date', `${year}-${m}-01`).lte('report_date', `${year}-${m}-31`);
            } else {
                const weeks = getWeeksInYear(parseInt(year));
                const w = weeks[subVal];
                query = query.gte('report_date', w.start.toISOString().split('T')[0]).lte('report_date', w.end.toISOString().split('T')[0]);
            }

            const { data, error } = await query.order('report_date');
            processAndRender(data, mode, year, subVal);
        }

        function processAndRender(data, mode, year, subVal) {
            let labels = [];
            let warmLeads = [];
            let hotLeads = [];

            if (mode === 'year') {
                labels = ["Th1", "Th2", "Th3", "Th4", "Th5", "Th6", "Th7", "Th8", "Th9", "Th10", "Th11", "Th12"];
                warmLeads = new Array(12).fill(0);
                hotLeads = new Array(12).fill(0);
                data.forEach(d => {
                    const m = new Date(d.report_date).getMonth();
                    warmLeads[m] += d.warm_leads;
                    hotLeads[m] += d.hot_leads;
                });
            } else if (mode === 'month') {
                labels = ["Tuần 1", "Tuần 2", "Tuần 3", "Tuần 4", "Tuần 5"];
                warmLeads = new Array(5).fill(0);
                hotLeads = new Array(5).fill(0);
                data.forEach(d => {
                    const day = new Date(d.report_date).getDate();
                    const w = Math.min(Math.floor((day - 1) / 7), 4);
                    warmLeads[w] += d.warm_leads;
                    hotLeads[w] += d.hot_leads;
                });
            } else {
                data.forEach(d => {
                    labels.push(new Date(d.report_date).toLocaleDateString('vi-VN', {weekday: 'short', day: '2-digit'}));
                    warmLeads.push(d.warm_leads);
                    hotLeads.push(d.hot_leads);
                });
            }

            renderChart(labels, warmLeads, hotLeads);
        }

        function renderChart(labels, warm, hot) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Warm Leads', data: warm, backgroundColor: '#3b82f6', borderRadius: 8 },
                        { label: 'Hot Leads', data: hot, backgroundColor: '#ef4444', borderRadius: 8 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        window.onload = initFilters;
    </script>
</body>
</html>
