<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Báo cáo Tổng hợp Call Center</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8 text-slate-900">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex justify-between items-center bg-slate-900 p-6 rounded-[30px] text-white shadow-xl">
            <div>
                <h1 class="text-xl font-black uppercase italic italic">Analytics Dashboard</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Dữ liệu hiệu suất Call Center</p>
            </div>
            <a href="index.html" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all">Quay lại</a>
        </div>

        <div class="bg-white p-6 rounded-[30px] shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">1. Năm</label>
                <select id="filter-year" onchange="updateSubFilters()" class="w-full bg-slate-50 p-3 rounded-xl font-bold border-none ring-1 ring-slate-200 outline-none">
                    <option value="2024">2024</option><option value="2025" selected>2025</option><option value="2026">2026</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">2. Xem theo</label>
                <select id="view-mode" onchange="updateSubFilters()" class="w-full bg-slate-50 p-3 rounded-xl font-bold border-none ring-1 ring-slate-200 outline-none">
                    <option value="year">Cả Năm</option>
                    <option value="month">Từng Tháng</option>
                    <option value="week" selected>Từng Tuần</option>
                </select>
            </div>
            <div id="sub-filter-container"></div>
            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 italic ml-1">4. Nhân viên</label>
                <select id="filter-user" class="w-full bg-slate-50 p-3 rounded-xl font-bold border-none ring-1 ring-slate-200 outline-none">
                    <option value="all">Tất cả nhân viên</option>
                </select>
            </div>
            <button onclick="fetchData()" class="bg-blue-600 text-white h-[48px] rounded-xl font-black uppercase italic hover:bg-slate-900 transition-all shadow-lg shadow-blue-200">Cập nhật</button>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-[30px] border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-6 italic tracking-widest">Biểu đồ diễn biến Leads</h3>
                <div class="h-[350px]"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-[30px] border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-6 italic tracking-widest">Tỷ lệ chất lượng Leads</h3>
                <div class="h-[350px] flex justify-center"><canvas id="pieChart"></canvas></div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-200 overflow-hidden">
            <h3 class="text-xs font-black uppercase text-slate-800 mb-6 italic tracking-widest border-b pb-4">Bảng Pivot: Tổng hợp hiệu suất</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] uppercase font-black text-slate-400 border-b">
                            <th class="p-4">Nhân sự</th>
                            <th class="p-4 text-center">Tổng Calls</th>
                            <th class="p-4 text-center">Thành công</th>
                            <th class="p-4 text-center text-blue-600">Warm Leads</th>
                            <th class="p-4 text-center text-red-500">Hot Leads</th>
                            <th class="p-4 text-center">Follow-ups</th>
                            <th class="p-4 text-center">Tỷ lệ chốt</th>
                        </tr>
                    </thead>
                    <tbody id="pivot-body" class="text-sm font-bold text-slate-700"></tbody>
                    <tfoot id="pivot-footer" class="bg-slate-900 text-white rounded-b-2xl"></tfoot>
                </table>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let chartBar = null, chartPie = null;

        // 1. Tự động cập nhật bộ lọc phụ (Tháng/Tuần)
        function updateSubFilters() {
            const mode = document.getElementById('view-mode').value;
            const year = parseInt(document.getElementById('filter-year').value);
            const container = document.getElementById('sub-filter-container');
            
            if (mode === 'year') {
                container.innerHTML = `<input type="hidden" id="sub-filter" value="all">`;
            } else if (mode === 'month') {
                container.innerHTML = `
                    <label class="text-[10px] font-black text-slate-400 uppercase italic ml-1">3. Chọn Tháng</label>
                    <select id="sub-filter" class="w-full bg-slate-50 p-3 rounded-xl font-bold ring-1 ring-slate-200 border-none outline-none">
                        ${[...Array(12).keys()].map(m => `<option value="${m+1}">Tháng ${m+1}</option>`).join('')}
                    </select>`;
            } else {
                const weeks = getWeeksInYear(year);
                container.innerHTML = `
                    <label class="text-[10px] font-black text-slate-400 uppercase italic ml-1">3. Chọn Tuần</label>
                    <select id="sub-filter" class="w-full bg-slate-50 p-3 rounded-xl font-bold ring-1 ring-slate-200 border-none outline-none text-[11px]">
                        ${weeks.map((w, i) => `<option value="${i}">${w.label}</option>`).join('')}
                    </select>`;
            }
        }

        // 2. Logic tính tuần theo Năm chọn
        function getWeeksInYear(year) {
            const weeks = []; let d = new Date(year, 0, 1);
            while (d.getDay() !== 1) d.setDate(d.getDate() + 1);
            while (d.getFullYear() <= year) {
                let s = new Date(d), e = new Date(d); e.setDate(e.getDate() + 6);
                if (s.getFullYear() > year) break;
                weeks.push({ 
                    label: `Tuần ${weeks.length+1} (${s.getDate()}/${s.getMonth()+1} - ${e.getDate()}/${e.getMonth()+1})`, 
                    start: new Date(s), end: new Date(e) 
                });
                d.setDate(d.getDate() + 7);
            }
            return weeks;
        }

        // 3. Load danh sách nhân viên vào combo
        async function loadStaffList() {
            const { data } = await supabaseClient.from('user_permissions').select('email, full_name').order('full_name');
            const select = document.getElementById('filter-user');
            data?.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.email; opt.textContent = u.full_name;
                select.appendChild(opt);
            });
        }

        // 4. Lấy dữ liệu từ Supabase
        async function fetchData() {
            const year = document.getElementById('filter-year').value;
            const mode = document.getElementById('view-mode').value;
            const subVal = document.getElementById('sub-filter').value;
            const userEmail = document.getElementById('filter-user').value;

            let query = supabaseClient.from('daily_reports').select('*');
            
            // Lọc thời gian
            if (mode === 'year') query = query.gte('report_date', `${year}-01-01`).lte('report_date', `${year}-12-31`);
            else if (mode === 'month') query = query.gte('report_date', `${year}-${subVal.padStart(2,'0')}-01`).lte('report_date', `${year}-${subVal.padStart(2,'0')}-31`);
            else { 
                const w = getWeeksInYear(parseInt(year))[subVal];
                query = query.gte('report_date', w.start.toISOString().split('T')[0]).lte('report_date', w.end.toISOString().split('T')[0]); 
            }

            // Lọc nhân viên
            if (userEmail !== 'all') query = query.eq('employee_email', userEmail);

            const { data } = await query.order('report_date');
            renderUI(data, mode);
        }

        // 5. Hiển thị Pivot Table & Charts
        function renderUI(data, mode) {
            const pivot = {};
            let grandTotal = { calls:0, win:0, warm:0, hot:0, follow:0 };

            data.forEach(d => {
                if (!pivot[d.employee_email]) pivot[d.employee_email] = { calls:0, win:0, warm:0, hot:0, follow:0 };
                ['total_calls','successful_calls','warm_leads','hot_leads','follow_ups'].forEach(col => {
                    const key = col.replace('total_','').replace('successful_','win').replace('_leads','');
                    pivot[d.employee_email][key === 'follow_ups' ? 'follow' : key] += d[col] || 0;
                    grandTotal[key === 'follow_ups' ? 'follow' : key] += d[col] || 0;
                });
            });

            // Render Body
            document.getElementById('pivot-body').innerHTML = Object.entries(pivot).map(([email, s]) => `
                <tr class="border-b border-slate-50 hover:bg-slate-50">
                    <td class="p-4 italic font-black text-slate-800">${email.split('@')[0]}</td>
                    <td class="p-4 text-center">${s.calls}</td><td class="p-4 text-center">${s.win}</td>
                    <td class="p-4 text-center text-blue-600">${s.warm}</td><td class="p-4 text-center text-red-500">${s.hot}</td>
                    <td class="p-4 text-center">${s.follow}</td>
                    <td class="p-4 text-center text-green-600">${((s.win/s.calls)*100 || 0).toFixed(1)}%</td>
                </tr>`).join('');

            // Render Footer (Total)
            document.getElementById('pivot-footer').innerHTML = `
                <tr class="font-black italic">
                    <td class="p-4 uppercase">TỔNG CỘNG</td>
                    <td class="p-4 text-center">${grandTotal.calls}</td><td class="p-4 text-center">${grandTotal.win}</td>
                    <td class="p-4 text-center">${grandTotal.warm}</td><td class="p-4 text-center">${grandTotal.hot}</td>
                    <td class="p-4 text-center">${grandTotal.follow}</td>
                    <td class="p-4 text-center text-green-400">${((grandTotal.win/grandTotal.calls)*100 || 0).toFixed(1)}%</td>
                </tr>`;

            renderCharts(data, mode);
        }

        function renderCharts(data, mode) {
            let labels = [], warm = [], hot = [];
            let tWarm = 0, tHot = 0;

            if (mode === 'year') {
                labels = ["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12"];
                warm = new Array(12).fill(0); hot = new Array(12).fill(0);
                data.forEach(d => { const m = new Date(d.report_date).getMonth(); warm[m]+=d.warm_leads; hot[m]+=d.hot_leads; });
            } else if (mode === 'month') {
                labels = ["Tuần 1", "Tuần 2", "Tuần 3", "Tuần 4", "Tuần 5"];
                warm = new Array(5).fill(0); hot = new Array(5).fill(0);
                data.forEach(d => { const w = Math.min(Math.floor((new Date(d.report_date).getDate()-1)/7), 4); warm[w]+=d.warm_leads; hot[w]+=d.hot_leads; });
            } else {
                data.forEach(d => { 
                    labels.push(new Date(d.report_date).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'}));
                    warm.push(d.warm_leads); hot.push(d.hot_leads);
                });
            }

            data.forEach(d => { tWarm += d.warm_leads; tHot += d.hot_leads; });

            if(chartBar) chartBar.destroy();
            chartBar = new Chart(document.getElementById('mainChart'), {
                type: 'bar', data: { labels, datasets: [
                    { label: 'Warm', data: warm, backgroundColor: '#3b82f6', borderRadius: 5 },
                    { label: 'Hot', data: hot, backgroundColor: '#ef4444', borderRadius: 5 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            if(chartPie) chartPie.destroy();
            chartPie = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut', data: { labels: ['Warm', 'Hot'], datasets: [
                    { data: [tWarm, tHot], backgroundColor: ['#3b82f6', '#ef4444'], borderWeight: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
        }

        window.onload = async () => { 
            updateSubFilters(); 
            await loadStaffList(); 
            fetchData(); 
        };
    </script>
</body>
</html>
