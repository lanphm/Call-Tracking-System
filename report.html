<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategic Hub - Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./config.js?v=refresh"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { background-color: white; color: #1e40af; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); font-weight: 900; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-black italic text-slate-900 uppercase tracking-tighter">Strategic Hub</h1>
                <p class="text-[9px] font-bold text-slate-400 mt-1 uppercase tracking-widest">Performance Sync v2026</p>
            </div>
            <div class="flex flex-wrap gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 w-full md:w-auto">
                <select id="year-filter" class="bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none"></select>
                <select id="month-filter" onchange="toggleFilters()" class="bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none">
                    <option value="all">Cả năm</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Tháng ${i}</option>`);</script>
                </select>
                <select id="week-filter" class="hidden bg-slate-50 border-none text-[11px] font-bold rounded-lg px-2 py-2 outline-none">
                    <option value="all">Cả tháng</option><option value="1">Tuần 1</option><option value="2">Tuần 2</option><option value="3">Tuần 3</option><option value="4">Tuần 4</option>
                </select>
                <select id="staff-filter" class="bg-slate-100 border-none text-[11px] font-black rounded-lg px-2 py-2 outline-none text-blue-900 max-w-[120px]">
                    <option value="all">Tất cả nhân sự</option>
                </select>
                <button onclick="loadData()" class="bg-blue-900 text-white text-[10px] font-black uppercase px-4 py-2 rounded-lg">Lọc</button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="summary-badges"></div>

        <div class="flex p-1 bg-slate-200/50 rounded-2xl mb-6 border border-slate-200">
            <button onclick="switchTab('tab-overview', this)" class="tab-btn active flex-1 py-2 text-[11px] uppercase rounded-xl">Đơn vị</button>
            <button onclick="switchTab('tab-staff', this)" class="tab-btn flex-1 py-2 text-[11px] font-bold uppercase rounded-xl text-slate-500">Nhân sự</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <div id="unit-performance-container" class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-6 overflow-x-auto hide-scrollbar"></div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-200 mb-6">
                <canvas id="overviewChart" height="120"></canvas>
            </div>
        </div>

        <div id="tab-staff" class="tab-content">
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-200 mb-6">
                <p class="text-[10px] font-black uppercase text-slate-400 mb-4 italic text-center">So sánh Success Calls</p>
                <canvas id="staffChart" height="120"></canvas>
            </div>
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-[11px]"><tbody id="staff-ranking-body"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        const THRESHOLDS = { showUp: { danger: 25, success: 45 }, conversion: { danger: 8, success: 18 } };
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let chartOV = null, chartST = null, fullData = [];

        async function setupYearFilter() {
            const currentYear = new Date().getFullYear();
            const { data } = await supabaseClient.from('daily_reports').select('report_date');
            let years = data ? data.map(r => new Date(r.report_date).getFullYear()) : [];
            years.push(currentYear);
            const uniqueYears = [...new Set(years)].sort((a, b) => b - a);
            document.getElementById('year-filter').innerHTML = uniqueYears.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
            loadData();
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-500'); });
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active'); el.classList.remove('text-slate-500');
            if(tabId === 'tab-staff') renderStaffChart();
        }

        function toggleFilters() {
            document.getElementById('week-filter').classList.toggle('hidden', document.getElementById('month-filter').value === 'all');
        }

        async function loadData() {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const week = document.getElementById('week-filter').value;
            let start, end;
            if (month === 'all') { start = `${year}-01-01`; end = `${year}-12-31`; }
            else {
                if (week === 'all') { start = `${year}-${month.padStart(2, '0')}-01`; end = new Date(year, month, 0).toISOString().split('T')[0]; }
                else {
                    const dS = (week - 1) * 7 + 1, dE = week == 4 ? 31 : week * 7;
                    start = `${year}-${month.padStart(2, '0')}-${String(dS).padStart(2, '0')}`;
                    end = `${year}-${month.padStart(2, '0')}-${String(dE).padStart(2, '0')}`;
                }
            }
            const { data, error } = await supabaseClient.from('daily_reports').select(`*, user_permissions(full_name), report_details(*, locations(name))`).gte('report_date', start).lte('report_date', end).order('report_date', { ascending: true });
            if (!error) { fullData = data; updateStaffDropdown(data); renderAll(); }
        }

        function updateStaffDropdown(data) {
            const staff = [...new Set(data.map(r => JSON.stringify({e: r.employee_email, n: r.user_permissions?.full_name})))];
            const select = document.getElementById('staff-filter');
            const cur = select.value;
            select.innerHTML = '<option value="all">Tất cả nhân sự</option>';
            staff.forEach(s => { const o = JSON.parse(s); select.innerHTML += `<option value="${o.e}">${o.n || o.e}</option>`; });
            select.value = cur;
        }

        function renderAll() {
            const selectedStaff = document.getElementById('staff-filter').value;
            const filtered = selectedStaff === 'all' ? fullData : fullData.filter(r => r.employee_email === selectedStaff);
            let gC=0, gS=0, gB=0, gA=0;
            const unitPivot = {}, staffPivot = {}, timePivot = {};

            filtered.forEach(r => {
                gC += r.total_calls || 0; gS += r.successful_calls || 0;
                const tKey = r.report_date;
                if(!timePivot[tKey]) timePivot[tKey] = {s: 0, b: 0};
                timePivot[tKey].s += r.successful_calls || 0;
                const name = r.user_permissions?.full_name || r.employee_email;
                if(!staffPivot[name]) staffPivot[name] = {s:0, b:0, h:0};
                staffPivot[name].s += r.successful_calls || 0; staffPivot[name].h += r.hot_leads || 0;

                if(r.report_details) {
                    r.report_details.forEach(d => {
                        const loc = d.locations?.name || 'N/A';
                        if(!unitPivot[loc]) unitPivot[loc] = {b:0, a:0, h:0};
                        unitPivot[loc].b += d.booked_count || 0; unitPivot[loc].a += d.attended_count || 0;
                        unitPivot[loc].h += Math.round((r.hot_leads || 0) / r.report_details.length);
                        gB += d.booked_count || 0; gA += d.attended_count || 0;
                        timePivot[tKey].b += d.booked_count || 0;
                        staffPivot[name].b += d.booked_count || 0;
                    });
                }
            });
            renderBadges(gC, gS, gB, gA);
            renderUnitTable(unitPivot, gC, gS);
            renderStaffTable(staffPivot);
            updateOverviewChart(timePivot);
        }

        function renderBadges(c, s, b, a) {
            document.getElementById('summary-badges').innerHTML = `
                <div class="bg-blue-900 p-4 rounded-[28px] text-white"><p class="text-[9px] font-black opacity-50 uppercase italic">Tổng Call</p><p class="text-xl font-black italic">${c}</p></div>
                <div class="bg-white p-4 rounded-[28px] border border-slate-100 shadow-sm"><p class="text-[9px] font-black text-slate-400 uppercase italic">Thành công</p><p class="text-xl font-black italic text-blue-900">${s}</p></div>
                <div class="bg-white p-4 rounded-[28px] border border-slate-100 shadow-sm"><p class="text-[9px] font-black text-slate-400 uppercase italic">Tổng Booking</p><p class="text-xl font-black italic text-blue-900">${b}</p></div>
                <div class="bg-emerald-500 p-4 rounded-[28px] text-white"><p class="text-[9px] font-black opacity-50 uppercase italic">Khách đến</p><p class="text-xl font-black italic">${a}</p></div>`;
        }

        function renderUnitTable(pivot, totalC, totalS) {
            const units = Object.keys(pivot);
            const totalB = Object.values(pivot).reduce((sum, u) => sum + u.b, 0);
            const getClr = (v, t) => v < THRESHOLDS[t].danger ? 'text-red-500' : (v > THRESHOLDS[t].success ? 'text-emerald-500' : 'text-blue-700');
            let html = `<table class="w-full text-left border-collapse text-[11px]">
                <thead class="bg-slate-50 border-b"><tr><th class="p-3 w-1/3"></th>${units.map(u => `<th class="p-3 text-center text-blue-900 font-black text-[10px] uppercase">${u}</th>`).join('')}</tr></thead>
                <tbody>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-400">Total Call</td><td colspan="${units.length}" class="text-center font-black bg-blue-50/30 text-blue-900 italic">${totalC}</td></tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-400">Total Success</td><td colspan="${units.length}" class="text-center font-black bg-emerald-50/30 text-emerald-600 italic">${totalS}</td></tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-400">Total Global Booking</td><td colspan="${units.length}" class="text-center font-black bg-orange-50/30 text-orange-600 italic">${totalB}</td></tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-500">Leads (Hot/Warm)</td>${units.map(u => `<td class="p-3 text-center font-bold text-slate-700">${pivot[u].h}</td>`).join('')}</tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-500">Booking</td>${units.map(u => `<td class="p-3 text-center font-bold text-blue-800">${pivot[u].b}</td>`).join('')}</tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-500">Conv. Rate</td>${units.map(u => { const r = (pivot[u].b/(totalC||1))*100; return `<td class="p-3 text-center font-black ${getClr(r, 'conversion')}">${r.toFixed(1)}%</td>`}).join('')}</tr>
                    <tr class="border-b"><td class="p-3 font-bold bg-slate-50 uppercase text-[8px] text-slate-500">Show-up Rate</td>${units.map(u => { const r = (pivot[u].a/(pivot[u].b||1))*100; return `<td class="p-3 text-center font-black ${getClr(r, 'showUp')}">${r.toFixed(0)}%</td>`}).join('')}</tr>
                    <tr class="bg-blue-900 text-white font-black italic shadow-inner"><td><span class="p-3 uppercase text-[9px] opacity-60">Attendants</span></td>${units.map(u => `<td class="p-3 text-center text-sm">${pivot[u].a}</td>`).join('')}</tr>
                </tbody></table>`;
            document.getElementById('unit-performance-container').innerHTML = html;
        }

        function renderStaffTable(staff) {
            const sorted = Object.entries(staff).sort((a,b) => b[1].s - a[1].s);
            document.getElementById('staff-ranking-body').innerHTML = sorted.map(([name, v]) => `
                <tr class="border-b"><td class="p-3 font-bold text-slate-700">${name}</td><td class="p-3 text-center font-black text-blue-900">${v.s} S.C</td><td class="p-3 text-center font-bold text-emerald-600">${v.b} Book</td><td class="p-3 text-right"><span class="bg-orange-50 text-orange-600 px-2 py-0.5 rounded-full font-black text-[9px] uppercase">${((v.h/(v.s||1))*100).toFixed(0)}% Hot</span></td></tr>`).join('');
            window.lastStaffData = staff;
        }

        function renderStaffChart() {
            const data = window.lastStaffData; if(!data) return;
            const ctx = document.getElementById('staffChart').getContext('2d');
            if (chartST) chartST.destroy();
            chartST = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data).map(v => v.s), backgroundColor: '#1e40af', borderRadius: 8 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } } } }
            });
        }

        function updateOverviewChart(timeData) {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            if (chartOV) chartOV.destroy();
            chartOV = new Chart(ctx, {
                type: 'line',
                data: { labels: Object.keys(timeData), datasets: [
                    { label: 'Success', data: Object.values(timeData).map(v => v.s), borderColor: '#1e40af', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(30, 64, 175, 0.05)' },
                    { label: 'Booking', data: Object.values(timeData).map(v => v.b), borderColor: '#10b981', borderWidth: 2, tension: 0.4, pointRadius: 0 }
                ]},
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } } } }
            });
        }
        window.onload = setupYearFilter;
    </script>
</body>
</html>
