<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Tổng Hợp</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-2 sm:p-6 font-sans">
    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        
        <div class="bg-slate-900 p-6 text-white">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black uppercase italic tracking-tighter">Performance Report</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Hệ thống phân tích dữ liệu cuộc gọi</p>
                </div>
                <a href="index.html" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-xs font-bold uppercase transition-all">Quay lại</a>
            </div>
            
            <div class="flex gap-2">
                <button onclick="renderReport('week')" id="tab-week" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase transition-all bg-blue-600 text-white">Theo Tuần</button>
                <button onclick="renderReport('month')" id="tab-month" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase transition-all bg-white/10 text-slate-400">Theo Tháng</button>
                <button onclick="renderReport('year')" id="tab-year" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase transition-all bg-white/10 text-slate-400">Theo Năm</button>
            </div>
        </div>

        <div class="overflow-x-auto p-4">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-100 text-[10px] uppercase font-black tracking-widest text-slate-600 border-b-2 border-slate-200">
                        <th class="p-4 border-r border-slate-200">ID (Nhân viên)</th>
                        <th id="col-time" class="p-4 border-r border-slate-200">Thời gian</th>
                        <th class="p-4 text-center border-r border-slate-200">SUM ShowUp</th>
                        <th class="p-4 text-center border-r border-slate-200">SUM ApptTotal</th>
                        <th class="p-4 text-center border-r border-slate-200">SUM CallsTotal</th>
                        <th class="p-4 text-center border-r border-slate-200 text-blue-700">Show Up Rate</th>
                        <th class="p-4 text-center text-emerald-700">Conversion Rate</th>
                    </tr>
                </thead>
                <tbody id="report-body" class="text-sm">
                    </tbody>
                <tfoot id="report-footer" class="bg-slate-50 font-black border-t-2 border-slate-300 text-slate-900">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let rawData = [];

        // HÀM TIỆN ÍCH
        const fmtPct = (num, den) => den > 0 ? ((num / den) * 100).toFixed(2) + '%' : '0.00%';
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getWeekRange(weekNo, year) {
            const firstDayOfYear = new Date(year, 0, 1);
            const days = (weekNo - 1) * 7;
            const res = new Date(year, 0, 1 + days);
            const dayOfWeek = res.getDay();
            const diff = res.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(res.setDate(diff));
            const sunday = new Date(res.setDate(monday.getDate() + 6));
            const f = (d) => d.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric'});
            return `${f(monday)} - ${f(sunday)}`;
        }

        async function fetchData() {
            const { data, error } = await supabaseClient.from('daily_reports').select('*, report_details(*)');
            if (error) return console.error(error);
            rawData = data;
            renderReport('week'); // Mặc định hiện tuần
        }

        function renderReport(type) {
            // Update UI Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.className = 'tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase transition-all bg-white/10 text-slate-400');
            document.getElementById(`tab-${type}`).className = 'tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase transition-all bg-blue-600 text-white';
            document.getElementById('col-time').innerText = type === 'week' ? 'Tuần' : (type === 'month' ? 'Tháng' : 'Năm');

            const grouped = {};
            let grandS = 0, grandA = 0, grandC = 0, grandSucc = 0;

            rawData.forEach(r => {
                const email = r.employee_email;
                const date = new Date(r.report_date);
                const yr = date.getFullYear();
                let timeKey = "";
                let timeLabel = "";

                if (type === 'week') {
                    const wk = getWeekNumber(date);
                    timeKey = `${yr}-W${wk.toString().padStart(2,'0')}`;
                    timeLabel = `Tuần ${wk} (${getWeekRange(wk, yr)})`;
                } else if (type === 'month') {
                    const mo = (date.getMonth() + 1).toString().padStart(2, '0');
                    timeKey = `${yr}-${mo}`;
                    timeLabel = `${yr}-${mo}`;
                } else {
                    timeKey = `${yr}`;
                    timeLabel = `${yr}`;
                }

                if (!grouped[email]) grouped[email] = { total: {s:0, a:0, c:0, succ:0}, times: {} };
                if (!grouped[email].times[timeKey]) grouped[email].times[timeKey] = { label: timeLabel, s:0, a:0, c:0, succ:0 };

                let dayS = 0, dayA = 0;
                r.report_details.forEach(d => { dayS += d.attended_count; dayA += d.booked_count; });

                const update = (obj) => {
                    obj.s += dayS; obj.a += dayA;
                    obj.c += r.total_calls; obj.succ += r.successful_calls;
                };

                update(grouped[email].times[timeKey]);
                update(grouped[email].total);
                
                grandS += dayS; grandA += dayA; grandC += r.total_calls; grandSucc += r.successful_calls;
            });

            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';

            Object.keys(grouped).sort().forEach(email => {
                const user = grouped[email];
                const timeKeys = Object.keys(user.times).sort();

                timeKeys.forEach((tk, idx) => {
                    const d = user.times[tk];
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition-all">
                            <td class="p-4 font-bold text-slate-700">${idx === 0 ? email : ''}</td>
                            <td class="p-4 text-slate-500 font-medium">${d.label}</td>
                            <td class="p-4 text-center font-mono">${d.s}</td>
                            <td class="p-4 text-center font-mono">${d.a}</td>
                            <td class="p-4 text-center font-mono">${d.c}</td>
                            <td class="p-4 text-center font-bold text-blue-600">${fmtPct(d.s, d.a)}</td>
                            <td class="p-4 text-center font-bold text-emerald-600">${fmtPct(d.succ, d.c)}</td>
                        </tr>`;
                });

                // Row Total cho từng User
                tbody.innerHTML += `
                    <tr class="bg-blue-50/50 font-black border-b-2 border-slate-200">
                        <td class="p-4 text-blue-800 text-xs">${email} TOTAL</td>
                        <td class="p-4"></td>
                        <td class="p-4 text-center">${user.total.s}</td>
                        <td class="p-4 text-center">${user.total.a}</td>
                        <td class="p-4 text-center">${user.total.c}</td>
                        <td class="p-4 text-center text-blue-700">${fmtPct(user.total.s, user.total.a)}</td>
                        <td class="p-4 text-center text-emerald-700">${fmtPct(user.total.succ, user.total.c)}</td>
                    </tr>`;
            });

            // Grand Total
            document.getElementById('report-footer').innerHTML = `
                <tr>
                    <td class="p-5" colspan="2">GRAND TOTAL</td>
                    <td class="p-5 text-center">${grandS}</td>
                    <td class="p-5 text-center">${grandA}</td>
                    <td class="p-5 text-center">${grandC}</td>
                    <td class="p-5 text-center text-blue-700 font-black text-base">${fmtPct(grandS, grandA)}</td>
                    <td class="p-5 text-center text-emerald-700 font-black text-base">${fmtPct(grandSucc, grandC)}</td>
                </tr>`;
        }

        window.onload = fetchData;
    </script>
</body>
</html>
