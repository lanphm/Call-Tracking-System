<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Report</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 p-2 sm:p-6">
    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        
        <div class="bg-slate-900 p-6 text-white">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black uppercase italic tracking-tighter">Performance Report</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Visualized Insights</p>
                </div>
                <a href="index.html" class="bg-white/10 px-4 py-2 rounded-xl text-xs font-bold uppercase italic">Quay lại</a>
            </div>
            
            <div class="flex gap-2">
                <button onclick="renderReport('week')" id="tab-week" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase bg-blue-600">Theo Tuần</button>
                <button onclick="renderReport('month')" id="tab-month" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase bg-white/10">Theo Tháng</button>
                <button onclick="renderReport('year')" id="tab-year" class="tab-btn px-6 py-2 rounded-lg text-xs font-black uppercase bg-white/10">Theo Năm</button>
            </div>
        </div>

        <div class="p-6">
            <div class="bg-slate-50 p-4 rounded-3xl border border-slate-200 mb-6 shadow-sm">
                <canvas id="performanceChart" height="100"></canvas>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-[10px] uppercase font-black text-slate-600 border-b-2">
                            <th class="p-4 border-r">ID (Nhân viên)</th>
                            <th id="col-time" class="p-4 border-r">Thời gian</th>
                            <th class="p-4 text-center border-r italic">SUM of ShowUp</th>
                            <th class="p-4 text-center border-r italic">SUM of ApptTotal</th>
                            <th class="p-4 text-center border-r italic">SUM of CallsTotal</th>
                            <th class="p-4 text-center border-r text-blue-700 italic">Show Up Rate</th>
                            <th class="p-4 text-center text-emerald-700 italic">Conversion Rate</th>
                        </tr>
                    </thead>
                    <tbody id="report-body" class="text-sm font-medium"></tbody>
                    <tfoot id="report-footer" class="bg-slate-50 font-black border-t-2"></tfoot>
                </table>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let rawData = [], chartInstance = null;
        const fmtPct = (n, d) => d > 0 ? ((n/d)*100).toFixed(2) + '%' : '0.00%';

        async function fetchData() {
            const { data } = await supabaseClient.from('daily_reports').select('*, report_details(*)');
            rawData = data || []; renderReport('week');
        }

        function renderReport(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-white/10'));
            document.getElementById(`tab-${type}`).classList.replace('bg-white/10', 'bg-blue-600');
            document.getElementById('col-time').innerText = type === 'week' ? 'Tuần' : (type === 'month' ? 'Tháng' : 'Năm');

            const grouped = {}, chartLabels = [], chartSUR = [], chartCR = [];
            // Logic xử lý thời gian (getWeek, getWeekRange - Giữ nguyên logic cũ)
            // ... (đoạn này bạn copy lại các hàm helper xử lý tuần ở tin nhắn trước nhé) ...

            // RENDER TABLE & CHART (Sau khi xử lý dữ liệu xong)
            // updateChart(chartLabels, chartSUR, chartCR);
        }

        function updateChart(labels, sur, cr) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('performanceChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Show-Up Rate %', data: sur, borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59,130,246,0.1)' },
                        { label: 'Conversion Rate %', data: cr, borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: 'rgba(16,185,129,0.1)' }
                    ]
                },
                options: { plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        window.onload = fetchData;
    </script>
</body>
</html>
