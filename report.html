<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACC CMS Report</title>
    <link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CallMS">
<link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/headset.png">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('PWA Ready'))
        .catch(err => console.log('PWA Error', err));
    });
  }
</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./config.js"></script>
    <style>
        select option { background-color: #1e293b; color: white; }
        @media (max-width: 640px) {
            .sticky-col { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div class="max-w-7xl mx-auto p-2 sm:p-8 space-y-4">
        
        <div class="bg-slate-900 p-6 md:p-10 rounded-[40px] text-white shadow-2xl space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">Report Analytics</h1>
                <button onclick="location.href='index.html'" class="bg-blue-600 px-6 py-2 rounded-xl text-[10px] font-black uppercase italic">Home</button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="bg-white/10 p-2 px-4 rounded-xl border border-white/10">
                    <span class="text-[8px] block opacity-50 uppercase font-black">Năm</span>
                    <select id="year-filter" onchange="initMonthOptions()" class="bg-transparent w-full text-white text-sm font-bold outline-none cursor-pointer"></select>
                </div>
                <div class="bg-white/10 p-2 px-4 rounded-xl border border-white/10">
                    <span class="text-[8px] block opacity-50 uppercase font-black">Tháng</span>
                    <select id="month-filter" onchange="handleMonthChange()" class="bg-transparent w-full text-white text-sm font-bold outline-none cursor-pointer"></select>
                </div>
                <div id="week-container" class="bg-blue-600/20 p-2 px-4 rounded-xl border border-blue-500/30">
                    <span class="text-[8px] block text-blue-400 uppercase font-black">Tuần</span>
                    <select id="week-filter" onchange="loadData()" class="bg-transparent w-full text-white text-sm font-bold outline-none cursor-pointer"></select>
                </div>
            </div>
        </div>

        <div id="summary-badge" class="grid grid-cols-2 md:grid-cols-4 gap-3 font-black text-center text-[10px] uppercase"></div>

        <div class="grid lg:grid-cols-5 gap-6">
            <div class="lg:col-span-2 bg-white rounded-[30px] shadow-sm border border-slate-200 overflow-hidden h-fit">
                <div class="p-4 bg-slate-900 text-white font-black italic uppercase text-[9px]">Xếp hạng Nhân viên</div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs min-w-[300px]">
                    <thead class="bg-slate-50 border-b"><tr><th class="p-3 sticky-col">Sales</th><th class="p-3 text-center">Call</th><th class="p-3 text-center text-blue-600">S.C</th><th class="p-3 text-center">%</th></tr></thead>
                    <tbody id="pivot-staff-body"></tbody>
                </table></div>
            </div>

            <div class="lg:col-span-3 bg-white rounded-[30px] shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-100 font-black italic uppercase text-[9px] text-slate-600">Lịch sử</div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs min-w-[350px]">
                    <thead class="bg-slate-50 border-b"><tr><th class="p-3" id="time-header">Thời gian</th><th class="p-3 text-center">Call</th><th class="p-3 text-center text-blue-600">S.C</th><th class="p-3 text-center text-red-500">Hot</th></tr></thead>
                    <tbody id="pivot-time-body"></tbody>
                </table></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[40px] shadow-sm border border-slate-200 h-[350px]">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let myChart = null;

        async function initYearOptions() {
            const { data } = await supabaseClient.from('daily_reports').select('report_date');
            const years = data ? [...new Set(data.map(r => new Date(r.report_date).getFullYear()))] : [new Date().getFullYear()];
            const select = document.getElementById('year-filter');
            select.innerHTML = '';
            years.sort((a,b) => b-a).forEach(y => select.add(new Option(y, y)));
            initMonthOptions();
        }

        function initMonthOptions() {
            const select = document.getElementById('month-filter');
            const now = new Date();
            const yearFilter = document.getElementById('year-filter').value;
            select.innerHTML = '<option value="all">Cả năm</option>';
            for (let i = 1; i <= 12; i++) {
                const opt = new Option(`Tháng ${i}`, i);
                if (yearFilter == now.getFullYear() && i == (now.getMonth()+1)) opt.selected = true;
                select.add(opt);
            }
            handleMonthChange();
        }

        function handleMonthChange() {
            const month = document.getElementById('month-filter').value;
            document.getElementById('week-container').style.display = (month === 'all' ? 'none' : 'block');
            if (month === 'all') loadData(); else initWeekOptions();
        }

        function initWeekOptions() {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const select = document.getElementById('week-filter');
            select.innerHTML = '<option value="all">Tất cả tuần</option>';
            // Logic tính tuần tương tự bản trước...
            loadData();
        }

        async function loadData() {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const week = document.getElementById('week-filter').value;
            let start, end;
            if (month === 'all') { start = `${year}-01-01`; end = `${year}-12-31`; }
            else { start = `${year}-${month.padStart(2, '0')}-01`; end = new Date(year, month, 0).toISOString().split('T')[0]; }

            const { data, error } = await supabaseClient.from('daily_reports').select(`*, user_permissions(full_name)` )
                .gte('report_date', start).lte('report_date', end).order('report_date', { ascending: true });
            if (!error) renderReports(data, month === 'all');
        }

        function renderReports(data, isYearly) {
            const staffPivot = {}; const timePivot = {};
            let gS=0, gC=0, gH=0;
            data.forEach(r => {
                const name = r.user_permissions?.full_name || r.employee_email;
                if(!staffPivot[name]) staffPivot[name] = {c:0, s:0};
                staffPivot[name].c += r.total_calls; staffPivot[name].s += r.successful_calls;
                gS += r.successful_calls; gC += r.total_calls; gH += r.hot_leads;

                const key = isYearly ? `Tháng ${new Date(r.report_date).getMonth()+1}` : r.report_date;
                if(!timePivot[key]) timePivot[key] = {c:0, s:0, h:0};
                timePivot[key].c += r.total_calls; timePivot[key].s += r.successful_calls; timePivot[key].h += r.hot_leads;
            });

            document.getElementById('summary-badge').innerHTML = `
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100"><span class="block opacity-40">Call</span>${gC}</div>
                <div class="bg-blue-50 p-3 rounded-2xl text-blue-600 shadow-sm border border-blue-100"><span class="block opacity-40">S.C</span>${gS}</div>
                <div class="bg-red-50 p-3 rounded-2xl text-red-600 shadow-sm border border-red-100"><span class="block opacity-40">Hot</span>${gH}</div>
                <div class="bg-slate-900 p-3 rounded-2xl text-white"><span class="block opacity-40">%</span>${((gS/(gC||1))*100).toFixed(1)}</div>`;

            document.getElementById('pivot-staff-body').innerHTML = Object.entries(staffPivot).sort((a,b)=>b[1].s-a[1].s).map(([n,v])=>`
                <tr class="border-t"><td class="p-3 sticky-col font-black italic">${n}</td><td class="p-3 text-center">${v.c}</td><td class="p-3 text-center font-black text-blue-600">${v.s}</td><td class="p-3 text-center opacity-40">${((v.s/(v.c||1))*100).toFixed(0)}%</td></tr>`).join('');

            document.getElementById('pivot-time-body').innerHTML = Object.entries(timePivot).reverse().map(([k,v])=>`
                <tr class="border-t text-[11px]"><td class="p-3 font-bold text-slate-500">${isYearly?k:k.split('-').reverse().slice(0,2).join('/')}</td><td class="p-3 text-center">${v.c}</td><td class="p-3 text-center font-black text-blue-600">${v.s}</td><td class="p-3 text-center font-black text-red-500">${v.h}</td></tr>`).join('');

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('mainChart'), {
                type: 'line', data: { labels: Object.keys(timePivot), datasets: [{ label: 'Success', data: Object.values(timePivot).map(v=>v.s), borderColor:'#3b82f6', tension:0.4, fill:true, backgroundColor:'rgba(59,130,246,0.05)' }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        window.onload = initYearOptions;
    </script>
</body>
</html>
