<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản trị - Internal App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./config.js"></script>
</head>
<body class="bg-slate-50 p-6">
    <div class="max-w-4xl mx-auto space-y-8">
        <div class="flex justify-between items-center bg-slate-900 p-6 rounded-3xl text-white">
            <h1 class="text-xl font-black italic uppercase">Admin Control Panel</h1>
            <button onclick="location.href='index.html'" class="text-xs bg-white/10 px-4 py-2 rounded-xl uppercase font-bold">Quay lại</button>
        </div>

        <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
            <h2 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">Phòng khám (Locations)</h2>
            <div id="location-list" class="space-y-3 mb-6"></div>
            <div class="flex gap-2">
                <input type="text" id="new-loc-name" placeholder="Tên phòng khám mới..." class="flex-1 bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold">
                <button onclick="addLocation()" class="bg-slate-900 text-white px-8 rounded-2xl font-black uppercase italic shadow-lg">Thêm</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
            <h2 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">Nhân viên (Permissions)</h2>
            <div id="user-list" class="space-y-4 mb-6"></div>
            <div class="grid grid-cols-2 gap-2 bg-slate-50 p-4 rounded-3xl">
                <input type="text" id="new-user-email" placeholder="Email Google..." class="bg-white p-3 rounded-xl border-none outline-none font-bold">
                <input type="text" id="new-user-name" placeholder="Họ tên..." class="bg-white p-3 rounded-xl border-none outline-none font-bold">
                <select id="new-user-role" class="bg-white p-3 rounded-xl border-none outline-none font-bold">
                    <option value="staff">Staff (Nhập liệu)</option>
                    <option value="viewer">Viewer (Chỉ xem)</option>
                    <option value="admin">Admin (Toàn quyền)</option>
                </select>
                <button onclick="addUser()" class="bg-blue-600 text-white rounded-xl font-black uppercase italic">Cấp quyền</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        async function loadData() {
            // Load Locations
            const { data: locs } = await supabaseClient.from('locations').select('*').order('name');
            document.getElementById('location-list').innerHTML = locs.map(l => `
                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl">
                    <span class="font-black italic uppercase text-sm">${l.name}</span>
                    <button onclick="toggleLoc('${l.id}', ${l.is_active})" class="text-[10px] font-bold uppercase ${l.is_active?'text-green-500':'text-red-500'}">${l.is_active?'Đang hoạt động':'Đã tắt'}</button>
                </div>`).join('');

            // Load Users
            const { data: users } = await supabaseClient.from('user_permissions').select('*').order('email');
            document.getElementById('user-list').innerHTML = users.map(u => `
                <div class="flex justify-between items-center border-b pb-4">
                    <div>
                        <p class="font-black text-sm">${u.full_name}</p>
                        <p class="text-[10px] text-slate-400 font-mono">${u.email} | Role: ${u.role.join(', ')}</p>
                    </div>
                    <button onclick="deleteUser('${u.email}')" class="text-red-500 text-[10px] font-black uppercase">Xóa</button>
                </div>`).join('');
        }

        async function addLocation() {
            const name = document.getElementById('new-loc-name').value;
            await supabaseClient.from('locations').insert([{ name, is_active: true }]);
            location.reload();
        }

        async function addUser() {
            const email = document.getElementById('new-user-email').value;
            const full_name = document.getElementById('new-user-name').value;
            const role = [document.getElementById('new-user-role').value];
            await supabaseClient.from('user_permissions').upsert([{ email, full_name, role, is_active: true }]);
            location.reload();
        }

        async function deleteUser(email) { if(confirm('Xóa?')) { await supabaseClient.from('user_permissions').delete().eq('email', email); loadData(); } }
        async function toggleLoc(id, current) { await supabaseClient.from('locations').update({ is_active: !current }).eq('id', id); loadData(); }

        window.onload = loadData;
    </script>
</body>
</html>
