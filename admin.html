<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n tr·ªã Whitelist</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-10 text-slate-900">
    <div class="max-w-6xl mx-auto space-y-8">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-900 p-8 rounded-[40px] text-white shadow-2xl gap-4">
            <div>
                <h1 class="text-3xl font-black uppercase italic tracking-tighter">Whitelist Manager</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase italic tracking-[0.2em]">Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p & Nh√¢n s·ª±</p>
            </div>
            <a href="index.html" class="bg-white/10 hover:bg-white/20 px-6 py-3 rounded-2xl text-[10px] font-black uppercase italic border border-white/5 transition-all">Quay l·∫°i trang ch·ªß</a>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="form-title" class="text-xs font-black uppercase text-blue-600 italic tracking-widest">Th√™m nh√¢n s·ª± m·ªõi</h2>
                    <button onclick="resetForm()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-red-500">L√†m m·ªõi</button>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1 italic">Email Google</label>
                        <input type="email" id="add-email" placeholder="example@gmail.com" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm transition-all">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-1 italic">H·ªç v√† T√™n</label>
                        <input type="text" id="add-name" placeholder="Nguy·ªÖn VƒÉn A" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm transition-all">
                    </div>
                    
                    <div class="bg-slate-50 p-5 rounded-3xl space-y-4">
                        <p class="text-[10px] font-black uppercase text-slate-400 mb-2 italic">Ph√¢n quy·ªÅn h·ªá th·ªëng:</p>
                        <div class="grid grid-cols-1 gap-3">
                            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-white rounded-xl transition-all">
                                <input type="checkbox" value="staff" class="role-checkbox w-5 h-5 rounded-lg border-slate-300 text-blue-600">
                                <span class="text-xs font-black uppercase italic group-hover:text-blue-600">Staff (Nh·∫≠p li·ªáu)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-white rounded-xl transition-all">
                                <input type="checkbox" value="viewer" class="role-checkbox w-5 h-5 rounded-lg border-slate-300 text-blue-600">
                                <span class="text-xs font-black uppercase italic group-hover:text-blue-600">Viewer (Xem b√°o c√°o)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-white rounded-xl transition-all">
                                <input type="checkbox" value="admin" class="role-checkbox w-5 h-5 rounded-lg border-slate-300 text-red-600">
                                <span class="text-xs font-black uppercase italic text-red-500 group-hover:text-red-600">Admin (Qu·∫£n tr·ªã)</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="saveUser()" class="w-full bg-slate-900 text-white p-5 rounded-[24px] font-black uppercase italic shadow-xl hover:bg-blue-600 transition-all transform active:scale-95">L∆∞u th√¥ng tin</button>
                    <p id="edit-notice" class="text-[8px] text-slate-400 text-center italic uppercase hidden">Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a: Email s·∫Ω ƒë∆∞·ª£c kh√≥a n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu b√°o c√°o.</p>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-8 rounded-[40px] shadow-sm border border-slate-200">
                <h2 class="text-xs font-black uppercase mb-6 text-slate-500 italic tracking-widest border-b pb-4">Danh s√°ch nh√¢n s·ª± h·ªá th·ªëng</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] uppercase font-black text-slate-400 border-b">
                                <th class="p-4">Nh√¢n s·ª±</th>
                                <th class="p-4">Quy·ªÅn h·∫°n</th>
                                <th class="p-4 text-right">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="user-list" class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let editingUserId = null;

        async function init() {
            loadUsers();
        }

        async function loadUsers() {
            try {
                // 1. L·∫•y danh s√°ch user
                const { data: users, error: err1 } = await supabaseClient.from('user_permissions').select('*').order('full_name');
                // 2. L·∫•y danh s√°ch email ƒë√£ c√≥ b√°o c√°o
                const { data: reports, error: err2 } = await supabaseClient.from('daily_reports').select('employee_email');
                
                if(err1 || err2) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

                const emailsWithData = new Set(reports.map(r => r.employee_email));

                document.getElementById('user-list').innerHTML = users.map(u => {
                    const hasData = emailsWithData.has(u.email);
                    return `
                        <tr class="border-b border-slate-50 hover:bg-slate-50 transition-all ${u.is_active ? '' : 'bg-red-50/50 opacity-60'}">
                            <td class="p-4">
                                <div class="font-black italic text-slate-800">${u.full_name} ${u.is_active ? '' : 'üîí'}</div>
                                <div class="text-[10px] font-mono text-slate-400">${u.email}</div>
                            </td>
                            <td class="p-4 flex gap-1 flex-wrap">
                                ${u.role.map(r => `<span class="px-2 py-0.5 rounded text-[8px] font-black uppercase ${r==='admin'?'bg-red-100 text-red-600':'bg-blue-100 text-blue-600'}">${r}</span>`).join('')}
                            </td>
                            <td class="p-4 text-right whitespace-nowrap">
                                <button onclick="editUser('${u.id}', '${u.email}', '${u.full_name}', '${u.role.join(',')}', ${hasData})" class="text-blue-500 hover:text-blue-700 font-black text-[10px] uppercase italic mr-3">S·ª≠a</button>
                                
                                ${hasData ? `
                                    <button onclick="toggleUserStatus('${u.id}', ${u.is_active})" class="${u.is_active ? 'text-orange-500' : 'text-green-500'} font-black text-[10px] uppercase italic">
                                        ${u.is_active ? 'Kh√≥a' : 'M·ªü'}
                                    </button>
                                ` : `
                                    <button onclick="removeUser('${u.id}')" class="text-red-400 hover:text-red-600 font-black text-[10px] uppercase italic">X√≥a</button>
                                `}
                            </td>
                        </tr>`;
                }).join('');
            } catch (error) {
                console.error(error);
            }
        }

        function editUser(id, email, name, roles, hasData) {
            editingUserId = id;
            document.getElementById('form-title').innerText = "Ch·ªânh s·ª≠a nh√¢n s·ª±";
            document.getElementById('edit-notice').classList.remove('hidden');
            
            const emailInput = document.getElementById('add-email');
            emailInput.value = email;
            if (hasData) {
                emailInput.readOnly = true;
                emailInput.classList.add('bg-slate-200', 'text-slate-500');
            } else {
                emailInput.readOnly = false;
                emailInput.classList.remove('bg-slate-200', 'text-slate-500');
            }

            document.getElementById('add-name').value = name;
            const roleList = roles.split(',');
            document.querySelectorAll('.role-checkbox').forEach(cb => {
                cb.checked = roleList.includes(cb.value);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function saveUser() {
            const email = document.getElementById('add-email').value.trim().toLowerCase();
            const fullName = document.getElementById('add-name').value.trim();
            const roles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(cb => cb.value);

            if(!email || !fullName || roles.length === 0) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!");

            const payload = { 
                email: email, 
                full_name: fullName, 
                role: roles,
                is_active: true // Khi l∆∞u/s·ª≠a m·∫∑c ƒë·ªãnh k√≠ch ho·∫°t l·∫°i
            };
            
            if (editingUserId) payload.id = editingUserId;

            const { error } = await supabaseClient.from('user_permissions').upsert(payload, { onConflict: 'email' });

            if(error) {
                alert("L·ªói l∆∞u d·ªØ li·ªáu: " + error.message);
            } else {
                alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                resetForm();
                loadUsers();
            }
        }

        async function toggleUserStatus(id, currentStatus) {
            if(confirm(`X√°c nh·∫≠n ${currentStatus ? 'KH√ìA' : 'M·ªû KH√ìA'} t√†i kho·∫£n n√†y?`)) {
                const { error } = await supabaseClient.from('user_permissions')
                    .update({ is_active: !currentStatus })
                    .eq('id', id);
                if(error) alert(error.message);
                loadUsers();
            }
        }

        async function removeUser(id) {
            if(confirm("X√≥a vƒ©nh vi·ªÖn nh√¢n s·ª± n√†y (Ch∆∞a c√≥ d·ªØ li·ªáu)?")) {
                const { error } = await supabaseClient.from('user_permissions').delete().eq('id', id);
                if(error) alert("Kh√¥ng th·ªÉ x√≥a: " + error.message);
                else loadUsers();
            }
        }

        function resetForm() {
            editingUserId = null;
            document.getElementById('form-title').innerText = "Th√™m nh√¢n s·ª± m·ªõi";
            document.getElementById('edit-notice').classList.add('hidden');
            document.getElementById('add-email').value = '';
            document.getElementById('add-email').readOnly = false;
            document.getElementById('add-email').classList.remove('bg-slate-200', 'text-slate-500');
            document.getElementById('add-name').value = '';
            document.querySelectorAll('.role-checkbox').forEach(cb => cb.checked = false);
        }

        window.onload = init;
    </script>
</body>
</html>
