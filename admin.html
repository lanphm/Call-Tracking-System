<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Whitelist</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-10 font-sans">
    <div class="max-w-6xl mx-auto space-y-6">
        
        <div class="bg-slate-900 p-8 rounded-[30px] text-white shadow-xl flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black uppercase italic italic">ADMIN PANEL</h1>
                <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Quản lý nhân sự & Phân quyền</p>
            </div>
            <a href="index.html" class="bg-white/10 hover:bg-white/20 px-5 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border border-white/10">Trang chủ</a>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-[30px] shadow-sm border border-slate-200 h-fit sticky top-6">
                <h2 id="form-title" class="text-xs font-black uppercase text-blue-600 mb-6 tracking-widest border-b pb-4">Thêm nhân sự</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase italic">Email Google</label>
                        <input type="email" id="add-email" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase italic">Họ và Tên</label>
                        <input type="text" id="add-name" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase italic">Quyền truy cập:</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" value="staff" class="role-checkbox w-4 h-4"><span class="text-xs font-bold uppercase italic">Staff</span></label>
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" value="viewer" class="role-checkbox w-4 h-4"><span class="text-xs font-bold uppercase italic">Viewer</span></label>
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" value="admin" class="role-checkbox w-4 h-4"><span class="text-xs font-bold uppercase italic text-red-500">Admin</span></label>
                        </div>
                    </div>

                    <button onclick="saveUser()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black uppercase italic shadow-lg hover:bg-blue-600 transition-all">Lưu thông tin</button>
                    <button onclick="resetForm()" class="w-full text-[10px] font-bold text-slate-400 uppercase">Hủy/Làm mới</button>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-[30px] shadow-sm border border-slate-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-[10px] uppercase text-slate-400 border-b">
                            <tr>
                                <th class="p-4">Nhân sự</th>
                                <th class="p-4">Quyền</th>
                                <th class="p-4 text-right">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="user-list" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let currentOldEmail = null; // Dùng email làm định danh chính

        async function loadUsers() {
            const { data: users } = await supabaseClient.from('user_permissions').select('*').order('full_name');
            const { data: reports } = await supabaseClient.from('daily_reports').select('employee_email');
            const emailsWithData = new Set(reports.map(r => r.employee_email));

            document.getElementById('user-list').innerHTML = users.map(u => {
                const hasData = emailsWithData.has(u.email);
                return `
                <tr class="border-b border-slate-50 transition-all ${u.is_active ? '' : 'bg-red-50 opacity-60'}">
                    <td class="p-4">
                        <div class="font-black italic">${u.full_name}</div>
                        <div class="text-[10px] font-mono text-slate-400">${u.email}</div>
                    </td>
                    <td class="p-4 font-bold text-[10px] uppercase text-blue-600">${u.role.join(', ')}</td>
                    <td class="p-4 text-right whitespace-nowrap">
                        <button onclick="editUser('${u.email}', '${u.full_name}', '${u.role.join(',')}', ${hasData})" class="text-blue-500 font-black text-[10px] uppercase italic mr-3">Sửa</button>
                        ${hasData ? `
                            <button onclick="toggleStatus('${u.email}', ${u.is_active})" class="text-orange-500 font-black text-[10px] uppercase italic">${u.is_active ? 'Khóa' : 'Mở'}</button>
                        ` : `
                            <button onclick="deleteUser('${u.email}')" class="text-red-400 font-black text-[10px] uppercase italic">Xóa</button>
                        `}
                    </td>
                </tr>`;
            }).join('');
        }

        function editUser(email, name, roles, hasData) {
            currentOldEmail = email;
            document.getElementById('form-title').innerText = "Cập nhật nhân sự";
            const emailInput = document.getElementById('add-email');
            emailInput.value = email;
            
            if(hasData) {
                emailInput.readOnly = true;
                emailInput.classList.add('bg-slate-200', 'text-slate-400');
            } else {
                emailInput.readOnly = false;
                emailInput.classList.remove('bg-slate-200', 'text-slate-400');
            }

            document.getElementById('add-name').value = name;
            const roleList = roles.split(',');
            document.querySelectorAll('.role-checkbox').forEach(cb => cb.checked = roleList.includes(cb.value));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function saveUser() {
            const newEmail = document.getElementById('add-email').value.trim().toLowerCase();
            const fullName = document.getElementById('add-name').value.trim();
            const roles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(cb => cb.value);

            if(!newEmail || !fullName || roles.length === 0) return alert("Điền đủ thông tin!");

            try {
                if (currentOldEmail && currentOldEmail !== newEmail) {
                    // Đổi email (chỉ dành cho user chưa có data)
                    const { error } = await supabaseClient.from('user_permissions')
                        .update({ email: newEmail, full_name: fullName, role: roles })
                        .eq('email', currentOldEmail);
                    if(error) throw error;
                } else {
                    // Upsert thông thường (Thêm mới hoặc sửa tên/quyền)
                    const { error } = await supabaseClient.from('user_permissions')
                        .upsert({ email: newEmail, full_name: fullName, role: roles, is_active: true }, { onConflict: 'email' });
                    if(error) throw error;
                }
                alert("Thành công!");
                resetForm();
                loadUsers();
            } catch (err) {
                alert("Lỗi: " + err.message);
            }
        }

        async function toggleStatus(email, status) {
            if(confirm(`Xác nhận ${status ? 'Khóa' : 'Mở'}?`)) {
                await supabaseClient.from('user_permissions').update({ is_active: !status }).eq('email', email);
                loadUsers();
            }
        }

        async function deleteUser(email) {
            if(confirm("Xóa vĩnh viễn user này?")) {
                const { error } = await supabaseClient.from('user_permissions').delete().eq('email', email);
                if(error) alert(error.message);
                else loadUsers();
            }
        }

        function resetForm() {
            currentOldEmail = null;
            document.getElementById('form-title').innerText = "Thêm nhân sự";
            const emailInput = document.getElementById('add-email');
            emailInput.value = '';
            emailInput.readOnly = false;
            emailInput.classList.remove('bg-slate-200', 'text-slate-400');
            document.getElementById('add-name').value = '';
            document.querySelectorAll('.role-checkbox').forEach(cb => cb.checked = false);
        }

        window.onload = loadUsers;
    </script>
</body>
</html>
