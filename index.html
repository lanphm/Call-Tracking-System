<script>
    // 1. Cấu hình
    const SUPABASE_URL = "https://ilxngmrnsghlgfqjxfni.supabase.co";
    // LƯU Ý: Bạn phải lấy mã ANON KEY ĐẦY ĐỦ (rất dài) trong Supabase dán vào đây
    const SUPABASE_ANON_KEY = "sb_publishable_-I0b_tYqzQF4Vk1i6nYGqA_pg0opuN_"; 
    
    // Đổi tên biến thành supabaseClient để tránh xung đột
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let locations = [];

    // 2. Kiểm tra trạng thái đăng nhập
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('form-section').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            loadLocations();
        }
    }

    // 3. Đăng nhập / Đăng xuất
    async function signIn() {
        console.log("Đang gọi hàm đăng nhập...");
        const { error } = await supabaseClient.auth.signInWithOAuth({ 
            provider: 'google',
            options: {
                redirectTo: window.location.origin
            }
        });
        if (error) alert("Lỗi đăng nhập: " + error.message);
    }

    async function signOut() {
        await supabaseClient.auth.signOut();
        window.location.reload();
    }

    // 4. Lấy danh mục cơ sở
    async function loadLocations() {
        const { data, error } = await supabaseClient.from('locations').select('*').eq('is_active', true);
        if (error) {
            console.error("Lỗi lấy danh mục:", error.message);
            return;
        }
        locations = data;
        const container = document.getElementById('location-inputs');
        container.innerHTML = '<h3 class="font-bold mb-2 text-gray-700">Chi tiết theo cơ sở:</h3>'; 
        data.forEach(loc => {
            const html = `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-bold text-blue-800 mb-2">${loc.name}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500">Booked</label>
                            <input type="number" id="booked_${loc.id}" class="w-full border p-2 rounded text-sm" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Attended</label>
                            <input type="number" id="attended_${loc.id}" class="w-full border p-2 rounded text-sm" placeholder="0">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // 5. Gửi dữ liệu
    async function submitReport() {
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = "ĐANG GỬI...";

        const { data: { user } } = await supabaseClient.auth.getUser();
        
        const { data: report, error: rError } = await supabaseClient.from('daily_reports').insert([{
            employee_email: user.email,
            total_calls: parseInt(document.getElementById('total_calls').value) || 0,
            successful_calls: parseInt(document.getElementById('successful_calls').value) || 0,
            remarks: document.getElementById('remarks').value
        }]).select().single();

        if (rError) {
            alert("Lỗi lưu báo cáo: " + rError.message);
            btn.disabled = false;
            btn.innerText = "GỬI BÁO CÁO";
            return;
        }

        const details = locations.map(loc => ({
            report_id: report.id,
            location_id: loc.id,
            booked_count: parseInt(document.getElementById(`booked_${loc.id}`).value) || 0,
            attended_count: parseInt(document.getElementById(`attended_${loc.id}`).value) || 0
        }));

        const { error: dError } = await supabaseClient.from('report_details').insert(details);

        if (dError) {
            alert("Lưu chi tiết lỗi: " + dError.message);
        } else {
            alert("Gửi báo cáo thành công!");
            window.location.reload();
        }
    }

    checkUser();
</script>
