// ... (Phần HTML giữ nguyên như bản trước) ...

async function checkUser() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('form-section').classList.remove('hidden');
    document.getElementById('user-email').innerText = user.email;

    // 1. LẤY QUYỀN TRỰC TIẾP TỪ DATABASE
    let { data: perm } = await supabaseClient.from('user_permissions')
        .select('*')
        .eq('email', user.email)
        .maybeSingle();
    
    // 2. NẾU CHƯA CÓ TRONG DB THÌ TỰ ĐĂNG KÝ VỚI QUYỀN 'PENDING'
    if (!perm) {
        const { data: newPerm } = await supabaseClient.from('user_permissions').insert([{ 
            email: user.email, 
            full_name: user.user_metadata.full_name, 
            role: 'pending' 
        }]).select().single();
        perm = newPerm;
    }

    userRole = perm.role; // Lấy role: 'admin', 'staff', hoặc 'pending'

    const btnSubmit = document.getElementById('btn-submit');
    const statusBadge = document.getElementById('status-badge');
    const adminBtn = document.getElementById('admin-btn');

    // 3. PHÂN QUYỀN GIAO DIỆN DỰA TRÊN ROLE TRONG DB
    if (userRole === 'admin' || userRole === 'staff') {
        // Cho phép nhập liệu
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('bg-slate-300', 'cursor-not-allowed');
        btnSubmit.classList.add('bg-blue-600', 'hover:bg-blue-700');
        btnSubmit.innerText = "Lưu Dữ Liệu";
        
        statusBadge.innerText = userRole === 'admin' ? "Quyền Quản Trị" : "Quyền Nhân Viên";
        statusBadge.className = "text-[10px] font-bold uppercase tracking-widest text-emerald-500 mt-1";
    } else {
        // Chặn nhập liệu nếu là 'pending'
        btnSubmit.innerText = "Tài khoản chờ duyệt...";
        statusBadge.innerText = "Vui lòng liên hệ Admin để kích hoạt";
        statusBadge.className = "text-[10px] font-bold uppercase tracking-widest text-amber-500 mt-1";
    }

    // 4. CHỈ HIỆN NÚT QUẢN TRỊ NẾU ROLE LÀ 'ADMIN'
    if (userRole === 'admin') {
        adminBtn.classList.remove('hidden');
    }

    await loadLocations();
    await loadExistingData();
}
